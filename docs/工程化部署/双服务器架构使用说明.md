# 双服务器架构使用说明

## 🎯 架构设计哲学

### 核心理念
> **"分离关注点，提升调试效率，降低重启成本"**

RAG系统采用**真正的双服务器架构**，将启动控制层与业务逻辑层完全分离：

```
┌─────────────────────────────────────────┐
│  【服务器1】静态Web服务器 (10808)        │
│  - 常驻运行，永不关闭                    │
│  - 资源占用极小 (~10MB)                  │
│  - 提供启动控制面板                      │
│  - 文件：static_server.py                │
│  - 【架构设计】管理虚拟环境myenv_stable  │
└─────────────────────────────────────────┘
            ↓ 控制（subprocess）
┌─────────────────────────────────────────┐
│  【服务器2】RAG主服务器 (5000)           │
│  - 按需启动/重启                         │
│  - 在虚拟环境中运行 (myenv_stable)      │
│  - 加载所有重资源（向量库、LLM等）       │
│  - 文件：rag_main_server.py              │
└─────────────────────────────────────────┘
```

---

## 📋 文件清单

### 核心服务器文件
| 文件名 | 端口 | 职责 | 启动方式 |
|-------|------|------|---------|
| `static_server.py` | 10808 | 静态页面托管 + 启动控制 | `python static_server.py` 或 `启动静态服务器.bat` |
| `rag_main_server.py` | 5000 | RAG核心业务逻辑 | 由 static_server 启动，或 `调试RAG主服务器.bat` |

### 前端文件
| 文件名 | 托管位置 | 功能 |
|-------|---------|------|
| `start.html` | 10808端口 | 启动控制页面 |
| `templates/chatroom.html` | 5000端口 | 多智能体聊天室 |
| `templates/base_agent_chat.html` | 5000端口 | 基类智能体交互 |

### 启动脚本
| 文件名 | 用途 |
|-------|------|
| `启动静态服务器.bat` | 启动常驻静态服务器 |
| `调试RAG主服务器.bat` | 直接启动RAG服务器（调试用） |

---

## 🚀 使用流程

### 正常使用（推荐）

#### 1. 启动静态服务器（仅需一次）
```bash
# 方式1：双击批处理脚本
启动静态服务器.bat

# 方式2：命令行
python static_server.py
```

**效果**：
- ✅ 静态服务器启动（10808端口）
- ✅ 资源占用极小，启动速度<1秒
- ✅ 可以常驻运行，永不关闭

#### 2. 浏览器访问启动页面
```
http://localhost:10808
```

#### 3. 填写用户信息 + 点击"启动系统"
- 系统自动调用 `/api/start_backend` 启动RAG主服务器
- 预计启动时间：5-10秒
- 页面自动跳转到 `http://localhost:5000/templates/chatroom.html`

#### 4. 使用RAG系统
- 多智能体聊天室：`http://localhost:5000/templates/chatroom.html`
- 基类智能体交互：`http://localhost:5000/templates/base_agent_chat.html`

---

### 调试模式（开发者用）

#### 场景：修改代码后快速重启RAG服务器

**传统单服务器方式**（繁琐）：
1. Ctrl+C 停止服务器
2. 重新运行 `python stable_start_server.py`
3. 等待加载...
4. ❌ 效率低

**双服务器方式**（高效）：
1. 修改代码
2. 浏览器刷新 `http://localhost:10808`
3. 点击"启动系统"
4. ✅ 自动重启RAG服务器，完成！

**或者**：
1. 修改代码
2. Ctrl+C 停止 RAG服务器（不停止静态服务器）
3. 双击 `调试RAG主服务器.bat`
4. ✅ 快速重启

---

## 🔍 架构优势

### 1️⃣ **调试效率提升 300%**
- 修改代码后，只需重启 RAG服务器（5000端口）
- 静态服务器（10808端口）无需重启，常驻运行
- 浏览器刷新 + 点击按钮，即可重启RAG服务器

### 2️⃣ **常驻轻量层**
- 静态服务器资源占用极小（~10MB）
- 启动速度<1秒，可以一直运行
- 无需每次都启动

### 3️⃣ **隔离关注点**
- 静态服务器：启动控制 + 静态页面托管
- RAG服务器：业务逻辑 + 重资源加载
- 职责清晰，维护简单

### 4️⃣ **虚拟环境管理优化**
- 【架构设计】虚拟环境myenv_stable由静态服务器管理
- 属于基础设施层，由常驻进程管理，避免重复加载
- RAG主服务器在虚拟环境中运行，但不负责虚拟环境的创建和管理
- 原因：虚拟环境是稳定的前置依赖，应与业务逻辑分离

### 5️⃣ **生产环境友好**
- 可独立重启RAG服务器，不影响启动层
- 支持多实例部署（负载均衡）
- 便于监控和管理

---

## 🛠️ API接口说明

### 静态服务器（10808端口）

#### `GET /api/health`
静态服务器健康检查

**响应**：
```json
{
  "status": "healthy",
  "service": "Static Web Server",
  "port": 10808,
  "timestamp": "2025-12-04T12:00:00"
}
```

#### `GET /api/status`
检查RAG主服务器状态

**响应**：
```json
{
  "status": "running",  // "running" | "starting" | "stopped"
  "message": "RAG系统运行正常",
  "port": 5000
}
```

#### `POST /api/start_backend`
启动RAG主服务器

**请求体**：
```json
{
  "mode": "/templates/chatroom.html",
  "username": "test_user"
}
```

**响应**：
```json
{
  "status": "success",
  "message": "RAG系统正在启动，请稍候...",
  "port": 5000,
  "estimated_time": "5-10秒"
}
```

#### `POST /api/stop_backend`
停止RAG主服务器

**响应**：
```json
{
  "status": "success",
  "message": "RAG系统已停止"
}
```

---

### RAG主服务器（5000端口）

#### `GET /api/health`
RAG系统健康检查

**响应**：
```json
{
  "version": "1.0.0",
  "message": "RAG系统运行正常",
  "status": "running",
  "python_version": "3.13.7",
  "numpy_version": "2.3.3",
  "timestamp": "2025-12-04T12:00:00"
}
```

#### `GET /api/chatroom/status`
聊天室状态

#### `POST /api/chatroom/message`
发送聊天室消息

---

## 📊 启动流程时序图

```
用户                静态服务器(10808)        RAG主服务器(5000)
 │                       │                        │
 │  访问 localhost:10808  │                        │
 ├─────────────────────>│                        │
 │                       │                        │
 │  填写信息 + 点击启动    │                        │
 ├─────────────────────>│                        │
 │                       │  subprocess启动        │
 │                       ├───────────────────────>│
 │                       │                        │
 │                       │  轮询健康检查          │
 │                       ├───────────────────────>│
 │                       │  ← 返回健康状态        │
 │                       │<───────────────────────┤
 │                       │                        │
 │  ← 自动跳转到 :5000    │                        │
 │<──────────────────────┤                        │
 │                       │                        │
 │  访问聊天室页面        │                        │
 ├────────────────────────────────────────────────>│
 │                       │                        │
```

---

## 🎓 设计哲学解读

### 为什么要双服务器？

**问题**：RAG服务器重启成本高
- 需要退出虚拟环境
- 需要重新运行启动命令
- 调试时频繁重启，效率低

**解决**：双服务器分离
- **轻量级常驻层**：静态服务器永不关闭，提供启动控制
- **重资源业务层**：RAG服务器按需启动，包含所有复杂功能
- **关注点分离**：启动控制 ≠ 业务逻辑

### 与传统架构对比

| 对比维度 | 传统单服务器 | 双服务器架构 |
|---------|------------|------------|
| 重启成本 | 高（需要重启所有） | 低（只重启RAG服务器） |
| 调试效率 | 低（Ctrl+C + 重启命令） | 高（浏览器刷新 + 点击） |
| 资源占用 | 高（总是加载所有资源） | 中（静态服务器极轻量） |
| 灵活性 | 低（难以独立重启） | 高（可独立管理） |
| 复杂度 | 低（单服务器） | 中（两个服务器） |

### 适用场景

✅ **推荐使用双服务器架构的场景**：
- 开发调试时频繁修改代码
- 需要快速重启RAG服务器
- 生产环境需要独立重启
- 需要负载均衡或多实例部署

❌ **不推荐使用双服务器架构的场景**：
- 代码已稳定，很少修改
- 只有简单的单页应用
- 系统资源极度受限

---

## 🚨 常见问题

### Q1: 如何停止RAG主服务器？
**A**: 有两种方式：
1. 调用 `POST /api/stop_backend` API
2. 直接 Ctrl+C 停止 RAG服务器进程

### Q2: 静态服务器需要常驻运行吗？
**A**: 推荐常驻运行，但不是必须的。如果关闭了，下次使用前需要重新启动。

### Q3: 为什么 start.html 在10808端口，聊天室在5000端口？
**A**: 这是双服务器架构的核心设计：
- `start.html` 托管在静态服务器（10808端口）
- 聊天室托管在RAG主服务器（5000端口）
- 启动后自动跳转：`10808` → `5000`

### Q4: 如何直接访问RAG主服务器（跳过静态服务器）？
**A**: 调试时可以直接运行 `调试RAG主服务器.bat`，然后访问 `http://localhost:5000/templates/chatroom.html`

### Q5: 虚拟环境由哪个服务器管理？
**A**: 【架构设计】虚拟环境myenv_stable由**静态服务器管理**，属于基础设施层。
- 虚拟环境路径：`myenv_stable`（项目根目录）
- 静态服务器启动RAG主服务器时，调用虚拟环境中的Python解释器
- RAG主服务器在虚拟环境中运行，但不负责虚拟环境管理
- 原因：虚拟环境是稳定的前置依赖，应由常驻进程管理，避免重复加载

### Q6: 如何修改端口？
**A**:
- 静态服务器：修改 `static_server.py` 中的 `start_static_server(port=10808)`
- RAG主服务器：修改 `rag_main_server.py` 中的 `PORT = 5000`

---

## 📝 总结

双服务器架构的精髓在于：

> **"让轻量的常驻服务器管理重量的按需服务器"**

通过分离关注点，我们实现了：
1. **快速调试**：修改代码后，浏览器刷新 + 点击启动，即可重启RAG服务器
2. **常驻控制层**：静态服务器永不关闭，随时可用
3. **资源隔离**：虚拟环境运行RAG服务器，依赖管理清晰
4. **灵活部署**：可独立重启、监控、扩展

这不仅仅是技术架构，更是一种**开发体验的优化**。

---

## 🔗 相关文档

- [前端启动后端设计思维记忆锚点.md](./前端启动后端设计思维记忆锚点.md)
- [自动跳转系统设计说明.md](./自动跳转系统设计说明.md)
- [前端启动后端使用说明.md](./前端启动后端使用说明.md)

---

**最后更新**：2025-12-04  
**架构版本**：v2.0（双服务器架构）
