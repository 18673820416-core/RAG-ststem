# åŸºç±»æ™ºèƒ½ä½“ + RAGå·¥å…·åŒ…æ¶æ„è¯´æ˜

## ğŸ“‹ æ¶æ„æ¦‚è¿°

æœ¬æ¶æ„é‡‡ç”¨**"åŸºç±» + å¤–ç½®å·¥å…·åŒ…"**æ¨¡å¼ï¼Œå®ç°ä»£ç å¤ç”¨ã€èŒè´£åˆ†ç¦»å’Œå¯ç»´æŠ¤æ€§æå‡ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å¯¹è¯çª—å£ (AgentConversationWindow)         â”‚
â”‚  - ç»´æŠ¤15åˆ†é’Ÿæ—¶é—´çª—å£å¯¹è¯å†å²                        â”‚
â”‚  - è°ƒç”¨æ™ºèƒ½ä½“æ—¶ä¼ å…¥ history_context                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ history_context
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åŸºç±»æ™ºèƒ½ä½“ (BaseAgent)                  â”‚
â”‚  - respond(message, history_context) æ ‡å‡†å…¥å£       â”‚
â”‚  - å¼•ç”¨å¤–ç½®RAGå·¥å…·åŒ…æ„å»ºä¸Šä¸‹æ–‡                       â”‚
â”‚  - è°ƒç”¨LLMç”Ÿæˆå“åº”                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RAGå·¥å…·åŒ…        â”‚  â”‚  å»é‡ç®¡ç†å™¨                 â”‚
â”‚  (å¤–ç½®Pythonæ¨¡å—) â”‚  â”‚  (ContextDeduplicationMgr)  â”‚
â”‚                   â”‚  â”‚                             â”‚
â”‚ â€¢ æ—¶é—´çª—å£è£å‰ª    â”‚â†â”€â”¤ â€¢ æ—¶é—´æˆ³å»é‡                â”‚
â”‚ â€¢ é•¿æœŸè®°å¿†æ£€ç´¢    â”‚  â”‚ â€¢ å†…å®¹å“ˆå¸Œå»é‡              â”‚
â”‚ â€¢ ä¸Šä¸‹æ–‡æ„å»º      â”‚  â”‚ â€¢ åˆ†å±‚ä¿¡æ¯åŠ è½½              â”‚
â”‚ â€¢ LLMæ¶ˆæ¯æ„å»º     â”‚  â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‘é‡æ•°æ®åº“      â”‚
â”‚  (VectorDatabase) â”‚
â”‚                   â”‚
â”‚ â€¢ é•¿æœŸè®°å¿†å­˜å‚¨    â”‚
â”‚ â€¢ æ—¶é—´è¿‡æ»¤æŸ¥è¯¢    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—‚ï¸ æ ¸å¿ƒæ–‡ä»¶

### 1. RAGå·¥å…·åŒ…ï¼ˆå¤–ç½®å·¥å…·æ¨¡å—ï¼‰

**æ–‡ä»¶**: [`src/rag_context_tools.py`](../../src/rag_context_tools.py)

**æä¾›èƒ½åŠ›**:
- `build_recent_history_context()` - æ ¹æ®æ—¶é—´çª—å£è£å‰ªè¿‘æœŸå†å²
- `retrieve_long_term_memories()` - ä»å‘é‡åº“æ£€ç´¢é•¿æœŸè®°å¿†ï¼ˆ>15åˆ†é’Ÿï¼‰
- `build_rag_context_text()` - æ„å»ºå»é‡åçš„RAGä¸Šä¸‹æ–‡æ–‡æœ¬
- `build_llm_messages()` - ç»Ÿä¸€æ„å»ºLLMæ¶ˆæ¯æ ¼å¼

**è‡ªæ›å…‰åè®®**:
```json
{
  "id": "rag_context_tools",
  "version": "1.0.0",
  "type": "tool",
  "provides": {
    "capabilities": [
      "æ—¶é—´çª—å£å†å²è£å‰ª",
      "é•¿æœŸè®°å¿†æ£€ç´¢",
      "å»é‡ä¸Šä¸‹æ–‡æ„å»º",
      "LLMæ¶ˆæ¯æ„å»º"
    ]
  }
}
```

### 2. åŸºç±»æ™ºèƒ½ä½“ï¼ˆå¼•ç”¨å·¥å…·åŒ…ï¼‰

**æ–‡ä»¶**: [`src/base_agent.py`](../../src/base_agent.py)

**ç‰ˆæœ¬å‡çº§**: `1.0.0` â†’ `2.0.0`

**æ ¸å¿ƒå˜æ›´**:

```python
# respondæ–¹æ³•ç­¾åå˜æ›´
def respond(self, message: str, history_context: Optional[List[Dict]] = None) -> Dict[str, Any]:
    """æ ‡å‡†å¯¹è¯å…¥å£ï¼š
    - ä¸Šå±‚è´Ÿè´£ä¼ å…¥ history_contextï¼ˆè¿‘15åˆ†é’Ÿå¯¹è¯å†å²ï¼‰
    - åŸºç±»è´Ÿè´£ï¼šæ„å»ºRAGä¸Šä¸‹æ–‡ + è°ƒç”¨LLM
    """
    # 1. å‘½ä»¤è§£æï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
    cmd = self._extract_command(message)
    if cmd:
        return self.call_tool("command_line", {...})
    
    # 2. ä½¿ç”¨RAGå·¥å…·åŒ…æ„å»ºä¸Šä¸‹æ–‡
    rag_context = build_rag_context_text(
        query=message,
        history_context=history_context or [],
        cutoff_minutes=15,
        limit=8,
    )
    
    # 3. ä½¿ç”¨RAGå·¥å…·åŒ…æ„å»ºmessages
    messages = build_llm_messages(
        system_prompt=self.core_system_prompt,
        rag_context=rag_context,
        user_query=message,
    )
    
    # 4. è°ƒç”¨LLM
    reply_text = self.llm_client.chat_completion(messages)
    return {"type": "text_reply", "reply": reply_text, ...}
```

### 3. å¯¹è¯çª—å£ï¼ˆä¼ å…¥å†å²ä¸Šä¸‹æ–‡ï¼‰

**æ–‡ä»¶**: [`src/agent_conversation_window.py`](../../src/agent_conversation_window.py)

**æ ¸å¿ƒå˜æ›´**:

```python
def _get_agent_response(self, message: str) -> str:
    """è·å–æ™ºèƒ½ä½“å“åº”ï¼ˆä¼ å…¥å†å²ä¸Šä¸‹æ–‡ï¼‰"""
    # ğŸ”§ æ„å»ºå†å²ä¸Šä¸‹æ–‡ï¼šè¿‘15åˆ†é’Ÿå¯¹è¯å†å²
    history_context = self._prepare_history_context_for_agent()
    
    # è°ƒç”¨æ™ºèƒ½ä½“respondæ–¹æ³•ï¼Œä¼ å…¥å†å²ä¸Šä¸‹æ–‡
    raw_response = self.agent_instance.respond(message, history_context=history_context)
    
    # å…¼å®¹BaseAgenté£æ ¼ï¼šå¤„ç†dictè¿”å›å€¼
    if isinstance(raw_response, dict):
        return raw_response.get('reply') or raw_response.get('content')
    return raw_response

def _prepare_history_context_for_agent(self) -> List[Dict]:
    """ä¸ºæ™ºèƒ½ä½“å‡†å¤‡å†å²ä¸Šä¸‹æ–‡ï¼ˆè¿‘15åˆ†é’Ÿå¯¹è¯å†å²ï¼‰"""
    # è¿‡æ»¤æ—¶é—´çª—å£å†…çš„å¯¹è¯
    filtered_history = []
    cutoff_time = datetime.now() - timedelta(minutes=15)
    for entry in self.conversation_history:
        if datetime.fromisoformat(entry['timestamp']) >= cutoff_time:
            filtered_history.append(entry)
    return filtered_history
```

## ğŸ”„ å®Œæ•´è°ƒç”¨é“¾è·¯

```
ç”¨æˆ·æ¶ˆæ¯
    â†“
AgentConversationWindow.receive_message()
    â†“
å‡†å¤‡15åˆ†é’Ÿå†å²ä¸Šä¸‹æ–‡ (_prepare_history_context_for_agent)
    â†“
è°ƒç”¨ agent.respond(message, history_context)
    â†“
BaseAgent.respond():
    â”œâ”€ build_rag_context_text()
    â”‚   â”œâ”€ build_recent_history_context()  # æ—¶é—´çª—å£è£å‰ª
    â”‚   â”œâ”€ retrieve_long_term_memories()   # å‘é‡åº“æ£€ç´¢
    â”‚   â””â”€ get_dedup_manager().build_deduplicated_context()  # å»é‡
    â”œâ”€ build_llm_messages()
    â””â”€ llm_client.chat_completion(messages)
    â†“
è¿”å›å“åº” {"type": "text_reply", "reply": "..."}
```

## âœ… æ¶æ„ä¼˜åŠ¿

### 1. **èŒè´£åˆ†ç¦»**
- **å¯¹è¯çª—å£**: ç»´æŠ¤å†å²ã€ç®¡ç†ä¸Šä¸‹æ–‡çª—å£
- **åŸºç±»æ™ºèƒ½ä½“**: åè°ƒRAGæµç¨‹ã€è°ƒç”¨LLM
- **RAGå·¥å…·åŒ…**: å°è£…RAGä¸Šä¸‹æ–‡æ„å»ºé€»è¾‘
- **å»é‡ç®¡ç†å™¨**: ä¸“æ³¨å»é‡ç­–ç•¥

### 2. **ä»£ç å¤ç”¨**
- æ‰€æœ‰ç»§æ‰¿ `BaseAgent` çš„åŠŸèƒ½æ™ºèƒ½ä½“è‡ªåŠ¨è·å¾—RAGèƒ½åŠ›
- RAGå·¥å…·åŒ…å¯è¢«å…¶ä»–æ¨¡å—ç‹¬ç«‹å¼•ç”¨
- å»é‡ç®¡ç†å™¨é€»è¾‘ç»Ÿä¸€ç®¡ç†

### 3. **å¯æµ‹è¯•æ€§**
- RAGå·¥å…·åŒ…å‡½æ•°å¯ç‹¬ç«‹æµ‹è¯•
- åŸºç±»æ™ºèƒ½ä½“å¯ä¼ å…¥æ¨¡æ‹Ÿå†å²ä¸Šä¸‹æ–‡æµ‹è¯•
- å¯¹è¯çª—å£å¯éªŒè¯å†å²ä¸Šä¸‹æ–‡ä¼ é€’

### 4. **å¯ç»´æŠ¤æ€§**
- RAGé€»è¾‘é›†ä¸­åœ¨å·¥å…·åŒ…ï¼Œä¿®æ”¹å½±å“èŒƒå›´å°
- åŸºç±»æ™ºèƒ½ä½“ä¸“æ³¨è°ƒåº¦ï¼Œä¸æ¶‰åŠRAGå®ç°ç»†èŠ‚
- ç¬¦åˆ"é‡æ„åº”è¦†ç›–åŸæ–‡ä»¶"åŸåˆ™ï¼ˆv2.0.0å‡çº§è€Œéæ–°å»ºï¼‰

## ğŸ“Š æ—¶é—´çª—å£ç­–ç•¥

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ç°åœ¨      15åˆ†é’Ÿå‰                    é•¿æœŸè®°å¿†
   â†“           â†“                            â†“
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚  æ–°é²œæœŸ   â”‚      é•¿æœŸè®°å¿†æ£€ç´¢èŒƒå›´       â”‚
   â”‚ (å¯¹è¯çª—å£)â”‚                             â”‚
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ–°é²œæœŸï¼ˆ0-15åˆ†é’Ÿï¼‰:
  - æ¥æº: AgentConversationWindow.conversation_history
  - ç­–ç•¥: å®Œæ•´ä¿ç•™åŸå§‹å¯¹è¯ï¼ˆæ— å‹ç¼©ï¼‰
  - ç›®çš„: ä¿æŒè¯­ä¹‰å®Œæ•´æ€§ï¼Œé˜²æ­¢ä¸Šä¸‹æ–‡æ–­è£‚

é•¿æœŸè®°å¿†ï¼ˆ>15åˆ†é’Ÿï¼‰:
  - æ¥æº: VectorDatabase.search_memories(end_time=15åˆ†é’Ÿå‰)
  - ç­–ç•¥: å‘é‡æ£€ç´¢ + æ—¶é—´æˆ³å»é‡
  - ç›®çš„: è¡¥å……ç›¸å…³é•¿æœŸçŸ¥è¯†ï¼Œé¿å…ä¸æ–°é²œæœŸé‡å¤
```

## ğŸ§ª æµ‹è¯•éªŒè¯

**æµ‹è¯•æ–‡ä»¶**: [`test_rag_tooling_architecture.py`](../../test_rag_tooling_architecture.py)

**æµ‹è¯•åœºæ™¯**:
1. âœ… åŸºç±»æ™ºèƒ½ä½“ä½¿ç”¨RAGå·¥å…·åŒ…ï¼ˆæ— å†å²ä¸Šä¸‹æ–‡ï¼‰
2. âœ… åŸºç±»æ™ºèƒ½ä½“ä½¿ç”¨RAGå·¥å…·åŒ…ï¼ˆå¸¦å†å²ä¸Šä¸‹æ–‡ï¼‰
3. âœ… RAGå·¥å…·åŒ…å‡½æ•°ç›´æ¥æµ‹è¯•
4. âœ… å¯¹è¯çª—å£ä¸RAGå·¥å…·åŒ…é›†æˆæµ‹è¯•

**è¿è¡Œæµ‹è¯•**:
```bash
python test_rag_tooling_architecture.py
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1ï¼šåŠŸèƒ½æ™ºèƒ½ä½“å¤ç”¨ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

```python
class CodeImplementerAgent(BaseAgent):
    """ä»£ç å®ç°å¸ˆæ™ºèƒ½ä½“ï¼ˆè‡ªåŠ¨ç»§æ‰¿RAGèƒ½åŠ›ï¼‰"""
    
    def __init__(self, agent_id: str):
        super().__init__(
            agent_id=agent_id,
            agent_type="ä»£ç å®ç°å¸ˆ",
            prompt_file="src/agent_prompts/code_implementer_prompt.md"
        )
        # æ— éœ€ä¿®æ”¹respondæ–¹æ³•ï¼Œç›´æ¥ç»§æ‰¿åŸºç±»RAGèƒ½åŠ›
```

### åœºæ™¯2ï¼šå¯¹è¯çª—å£è°ƒç”¨

```python
from src.base_agent import BaseAgent
from src.agent_conversation_window import AgentConversationWindow

# åˆ›å»ºæ™ºèƒ½ä½“
agent = CodeImplementerAgent(agent_id="implementer_001")

# åˆ›å»ºå¯¹è¯çª—å£
window = AgentConversationWindow(
    agent_id="implementer_001",
    agent_role="ä»£ç å®ç°å¸ˆ",
    agent_instance=agent
)

# å¯¹è¯ï¼ˆçª—å£è‡ªåŠ¨ä¼ å…¥15åˆ†é’Ÿå†å²ä¸Šä¸‹æ–‡ï¼‰
result = window.receive_message("å®ç°ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½", sender="user")
```

### åœºæ™¯3ï¼šä¸´æ—¶æ™ºèƒ½ä½“

```python
from src.agent_manager import AgentManager

# ä¸´æ—¶æ™ºèƒ½ä½“åŸºäºBaseAgentæ„å»ºï¼Œè‡ªåŠ¨è·å¾—RAGèƒ½åŠ›
temp_agent = AgentManager.create_temporary_agent(
    task_name="æ•°æ®åˆ†æä»»åŠ¡",
    task_description="åˆ†æç”¨æˆ·è¡Œä¸ºæ•°æ®",
    llm_client=llm_client  # å¤ç”¨LLMå®¢æˆ·ç«¯
)

# ä¼ å…¥å†å²ä¸Šä¸‹æ–‡è°ƒç”¨
response = temp_agent.respond(
    message="åˆ†ææœ€è¿‘ä¸€å‘¨çš„ç”¨æˆ·ç™»å½•è¶‹åŠ¿",
    history_context=recent_history  # ç”±è°ƒç”¨æ–¹æä¾›
)
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ä¸Šä¸‹æ–‡ç®¡ç†ä¼˜åŒ–æ–¹æ¡ˆ](./ä¸Šä¸‹æ–‡ç®¡ç†ä¼˜åŒ–æ–¹æ¡ˆ.md)
- [RAGæ¶æ„æ ¸å¿ƒæ–‡æ¡£](../../README.md)
- [å»é‡ç®¡ç†å™¨è®¾è®¡](../../src/context_deduplication_manager.py)
- [åŸºç±»æ™ºèƒ½ä½“æç¤ºè¯](../../src/agent_prompts/base_agent_prompt.md)

## ğŸ¯ åç»­ä¼˜åŒ–æ–¹å‘

1. **å‘é‡åº“æ£€ç´¢ä¼˜åŒ–**: æ”¯æŒå¤šæ¨¡æ€æ£€ç´¢ï¼ˆæ–‡æœ¬+å›¾åƒï¼‰
2. **æ—¶é—´çª—å£è‡ªé€‚åº”**: æ ¹æ®å¯¹è¯å¯†åº¦åŠ¨æ€è°ƒæ•´15åˆ†é’Ÿçª—å£
3. **å»é‡ç­–ç•¥å¢å¼º**: æ”¯æŒè¯­ä¹‰å»é‡ï¼ˆä¸ä»…åŸºäºæ—¶é—´æˆ³ï¼‰
4. **RAGå·¥å…·åŒ…æ‰©å±•**: å¢åŠ çŸ¥è¯†å›¾è°±æ£€ç´¢æ”¯æŒ
5. **æ€§èƒ½ç›‘æ§**: æ·»åŠ RAGä¸Šä¸‹æ–‡æ„å»ºè€—æ—¶ç»Ÿè®¡

---

**æ¶æ„ç‰ˆæœ¬**: 2.0.0  
**æ–‡æ¡£æ›´æ–°æ—¶é—´**: 2025-12-09  
**ç»´æŠ¤è€…**: RAGç³»ç»Ÿæ¶æ„ç»„
