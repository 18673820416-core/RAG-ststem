# RAG系统优化与概念对齐计划（记忆锚点版）

## 一、RAG概念对齐

### 传统RAG核心要素
- **检索（Retrieval）**：从外部知识库中检索相关信息
- **增强（Augmentation）**：将检索到的信息与用户查询结合
- **生成（Generation）**：基于增强后的信息生成响应

### 当前系统与RAG的差距
- **向量生成简单**：使用自定义12维向量，而非专业embedding模型
- **没有用户问题改写**：直接使用用户原始问题进行检索
- **缺少观察步骤**：未对结果与任务的拟合度进行自我检查
- **检索机制基础**：主要基于关键词匹配，向量相似度计算简单

## 二、优化方案

### 1. 实现观察步骤（核心优化）
**目标**：在智能体响应流程中添加观察步骤，评估结果与任务的拟合度

**实现**：
- 在 BaseAgent.respond 方法中添加 _observe_result 方法
- 实现两阶段评估：
  - 本地评估：使用关键词匹配、语义相似度等轻量级方法
  - LLM评估：仅当本地评估分数低于阈值时，使用LLM进行深度评估
- 添加拟合度阈值设置（默认0.7）
- 实现多轮重试机制，若拟合度低则重新生成响应
- 记录评估结果，用于系统优化

### 2. 启用本地embedding模型
**目标**：使用系统已配置的本地embedding模型，提升向量质量

**实现**：
- 安装并使用 sentence-transformers 库加载 all-MiniLM-L6-v2 模型
- 替换 _generate_content_vector 方法，使用本地embedding
- 统一向量维度为384维（模型默认）
- 实现embedding缓存机制，避免重复计算
- 添加embedding质量评估，确保向量生成质量

### 3. 添加轻量级用户问题改写
**目标**：使用轻量级方法生成优化的检索查询，提升检索效果

**实现**：
- 在 chat_engine.py 中添加 _rewrite_query 方法
- 仅使用本地NLP工具（jieba分词、关键词提取）生成改写查询
- 支持生成多个检索查询变体，选择最佳查询
- 记录改写查询效果，用于系统优化

### 4. 优化检索机制
**目标**：结合本地embedding和关键词匹配，实现精准检索

**实现**：
- 改进 search_memories 方法，支持使用本地embedding进行相似度计算
- 实现混合检索策略，根据查询类型自动调整权重
- 添加检索结果排序优化，优先展示高质量结果
- 实现检索结果质量评估，过滤低质量结果
- 记录检索效果，用于系统优化

## 三、实施步骤

### 第一步：实现观察步骤
- 在 base_agent.py 中添加 _observe_result 方法
- 实现两阶段评估逻辑
- 在 respond 方法中集成观察步骤
- 添加多轮重试机制
- 测试观察步骤效果，调整评估阈值

### 第二步：启用本地embedding模型
- 安装 sentence-transformers 库
- 修改 _generate_content_vector 方法，使用本地embedding
- 实现embedding缓存机制
- 测试embedding生成质量和性能
- 优化embedding生成流程，提高生成速度

### 第三步：添加轻量级用户问题改写
- 在 chat_engine.py 中添加 _rewrite_query 方法
- 实现本地NLP方法生成改写查询
- 测试查询改写效果
- 优化改写逻辑，提高改写速度
- 记录改写查询效果

### 第四步：优化检索机制
- 改进 search_memories 方法，支持本地embedding检索
- 实现混合检索策略
- 测试检索准确性和效率
- 添加检索结果质量评估
- 记录检索效果

### 第五步：保存计划作为记忆锚点
- 将本计划保存到 docs/RAG系统优化与概念对齐计划.md
- 添加版本控制，记录优化进度
- 定期更新计划，记录系统进化路线
- 确保计划可以清晰展示RAG的进化节点

## 四、预期效果

- **结果质量提升**：通过观察步骤，确保响应结果与用户需求高度拟合
- **检索准确性提升**：使用本地embedding和改写查询，提高检索准确率
- **成本降低**：优先使用本地资源，减少API调用成本
- **系统可靠性增强**：观察步骤确保结果质量，降低错误率
- **记忆锚点建立**：清晰记录系统进化路线，便于后续优化

## 五、风险评估与解决方案

### 本地算力性能不足
**解决方案**：实现自动降级机制，当本地算力不足时自动切换到中央算力

### 观察步骤耗时
**解决方案**：
- 优化本地评估算法，减少评估时间
- 实现异步评估，不阻塞用户交互

### embedding生成速度慢
**解决方案**：
- 优化embedding生成流程
- 实现缓存机制，避免重复计算

### 系统复杂度增加
**解决方案**：
- 保持模块化设计，完善文档和测试
- 实现清晰的API接口，便于后续扩展

## 六、记忆锚点说明

本计划将作为RAG系统的记忆锚点，记录系统的进化路线。每完成一个优化步骤，将在计划中添加完成时间和效果评估，形成完整的系统进化记录。同时，将定期更新计划，添加新的优化目标和实施步骤，确保系统持续进化。

记忆锚点将保存在 docs 文件夹中，便于团队成员查阅和参考。通过记忆锚点，可以清晰了解系统的进化历程，为后续优化提供参考。

## 七、"更好、更便宜"实现路径

### 更好
- 通过观察步骤，确保结果质量
- 使用本地embedding，提升向量质量
- 优化检索机制，提高检索准确性
- 记录系统效果，持续优化

### 更便宜
- 优先使用本地资源，减少API调用成本
- 实现缓存机制，避免重复计算
- 优化算法，减少计算资源消耗
- 记录成本使用情况，持续优化

### 用户选择
- 提供更准确、更可靠的服务
- 降低使用成本，让用户更愿意选择
- 持续优化，保持系统竞争力

通过以上优化，我们将实现RAG系统"更好、更便宜"的目标，吸引更多用户选择我们的系统，形成良性循环，持续提升系统智能。