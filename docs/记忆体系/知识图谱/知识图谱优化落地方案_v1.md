# 知识图谱优化落地方案 v1

> 目标：在不破坏现有架构的前提下，以“LLM+工具集”为系统胶水，补齐知识图谱的关键能力，将松散模块编排为可观测的闭环系统。
> 放置位置：`docs/记忆体系/知识图谱/`（开发阶段文档集中管理）

---

## 一、系统认知与原则
- **系统胶水**：LLM的主观能动性 + 多智能体聊天室的语义协作
- **能力导向**：组件以“能力”自曝光，LLM基于能力路由，不依赖硬编码引用
- **自曝光协议**：组件在文件头第2行维护`@self-expose`注释（id/name/type/version/needs/provides），每次更新必须同步版本和能力列表
- **告警与上报**：能力缺失触发一级完整性告警，并按协议二级报错机制上报详情

---

## 二、能力清单（LLM可调用）
- `knowledge_graph.build`：按主题/重要性等维度构建图谱
- `knowledge_graph.time_sequence`：基于时间戳生成时间序列边
- `knowledge_graph.causal_edges`：基于因果标注生成因果关系边
- `knowledge_graph.search_across_layers`：跨层级语义搜索（分布统计+导航）
- `knowledge_graph.get_layer_navigation`：层级上下游与兄弟层导航

---

## 三、代码改动（已执行）
- `src/mesh_database_interface.py`
  - 自曝光版本：`1.0.0 → 1.1.0`
  - 新增：事件时间序列边（按`event_ts`或`timestamp`）
  - 新增：因果关系边（基于`cause/effect/causes/effects`）
  - 保留：多维度关联构建（重要性层级、内容相似度等）
- `src/multi_layer_graph_manager.py`
  - 自曝光版本：`1.0.0 → 1.1.0`
  - 能力声明：`knowledge_graph.search_across_layers`、`knowledge_graph.get_layer_navigation`
  - 现有：自动子层创建、层间连接、跨层搜索、相关性评分

---

## 四、调用方式（智能体/LLM）
- 在多智能体聊天室中触发：
  - “生成主题X的知识图谱”（路由到`knowledge_graph.build`）
  - “查看主题X的时间线”（路由到`knowledge_graph.time_sequence`）
  - “分析事件Y的因果链”（路由到`knowledge_graph.causal_edges`）
  - “跨层搜索关键词Z”（路由到`knowledge_graph.search_across_layers`）
  - “导航到主题X的子层”（路由到`knowledge_graph.get_layer_navigation`）
- 返回结构：节点/边/层级分布/覆盖率/矛盾数（用于下一轮对话的决策）

---

## 五、可观测性与报错
- 每次构建/检索输出：
  - 节点数、边数、覆盖率、层级分布、时间线边数、因果边数
- 能力缺失或调用失败：
  - 触发一级完整性告警；按二级报错机制上报缺失详情（能力名、组件id、版本、参数）

---

## 六、迭代路线（建议顺序）
1. 事件/因果索引（已落地最小可用）
2. 跨层检索与导航（现有接口完善返回结构与评分）
3. 网状思维引擎的多维关联（人物/时间/概念/主题/因果综合）
4. 动态反应机制（增量更新、缓存、结构重组）
5. 双引擎协同验证（理性认知/认知破障，输出矛盾/置信度）
6. 大规模优化（分层索引、并行检索、采样与重要性分布控制）

---

## 七、风险与控制
- 文档超前风险：定期核对DOCS与代码一致性，标注进度（如`[进度:60%][需迭代]`）
- 性能风险：在大规模数据下启用分层抽样与缓存；仅在必要时触发重组
- 兼容性风险：保持接口向后兼容，新增能力以可选参数形式扩展

---

## 八、位置与版本
- 文档路径：`docs/记忆体系/知识图谱/知识图谱优化落地方案_v1.md`
- 版本：v1.0（2025-12-05）
- 关联组件版本：
  - `mesh_database_interface`: v1.1.0
  - `multi_layer_graph_manager`: v1.1.0

---

## 九、下一步（建议）
- 在`AgentToolIntegration`中映射以上能力名到具体实现（可选）
- 在`main.py`构建入口输出覆盖率与层级分布统计，形成闭环可观测性
- 将热点图谱缓存为文件以便快速载入（`data/graph_cache/*.json`）
