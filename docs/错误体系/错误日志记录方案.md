# RAGç³»ç»Ÿé”™è¯¯æ—¥å¿—è®°å½•æ–¹æ¡ˆ

## æ–¹æ¡ˆæ¦‚è¿°

ä¸ºäº†è§£å†³å‰ç«¯æ§åˆ¶å°æŠ¥é”™"net::ERR_CONNECTION_REFUSED"ç­‰é”™è¯¯ä¿¡æ¯ä¸è¢«æ™ºèƒ½ä½“æ„ŸçŸ¥çš„é—®é¢˜ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€å¥—ç»Ÿä¸€çš„é”™è¯¯æ—¥å¿—è®°å½•ç³»ç»Ÿï¼Œç¡®ä¿æ‰€æœ‰æœåŠ¡å™¨é”™è¯¯éƒ½èƒ½è¢«æ™ºèƒ½ä½“è¯»å–å’Œç›‘æ§ã€‚

## æ ¸å¿ƒè®¾è®¡ç†å¿µ

- **ç»Ÿä¸€è®°å½•**ï¼šæ‰€æœ‰é”™è¯¯ä¿¡æ¯ç»Ÿä¸€è®°å½•åˆ°æŒ‡å®šæ–‡ä»¶
- **åŒé‡è¾“å‡º**ï¼šåŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œæ—¥å¿—æ–‡ä»¶
- **æ™ºèƒ½æ„ŸçŸ¥**ï¼šæ™ºèƒ½ä½“é€šè¿‡è¯»å–æ—¥å¿—æ–‡ä»¶æ„ŸçŸ¥ç³»ç»ŸçŠ¶æ€
- **é”™è¯¯åˆ†ç±»**ï¼šæŒ‰é”™è¯¯ç±»å‹å’Œä¸¥é‡ç¨‹åº¦è¿›è¡Œåˆ†ç±»

## æŠ€æœ¯å®ç°

### 1. é”™è¯¯æ—¥å¿—é…ç½®

åœ¨<mcfile name="start_server.py" path="E:\RAGç³»ç»Ÿ\start_server.py"></mcfile>ä¸­å®ç°ï¼š

```python
# é”™è¯¯æ—¥å¿—é…ç½®
logs_dir = os.path.join(os.path.dirname(__file__), 'logs')
if not os.path.exists(logs_dir):
    os.makedirs(logs_dir)

error_log_path = os.path.join(logs_dir, 'server_errors.log')
logging.basicConfig(
    level=logging.ERROR,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(error_log_path, encoding='utf-8'),
        logging.StreamHandler()  # åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
    ]
)
```

### 2. é”™è¯¯è®°å½•æ–¹æ³•

```python
def log_error(self, error_type, error_message, details=None):
    """ç»Ÿä¸€è®°å½•é”™è¯¯ä¿¡æ¯"""
    error_info = f"{error_type}: {error_message}"
    if details:
        error_info += f" | è¯¦æƒ…: {details}"
    
    # è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶
    self.error_logger.error(error_info)
    
    # åŒæ—¶æ‰“å°åˆ°æ§åˆ¶å°ï¼ˆä¾¿äºå®æ—¶ç›‘æ§ï¼‰
    print(f"ğŸ”´ [é”™è¯¯] {error_info}")
```

### 3. å…³é”®é”™è¯¯å¤„ç†ç‚¹

#### æ ¹è·¯å¾„HTMLé¡µé¢ç”Ÿæˆ
```python
try:
    # è¿”å›å¯åŠ¨é¡µé¢å†…å®¹
    self.send_response(200)
    self.send_header('Content-type', 'text/html; charset=utf-8')
    self.end_headers()
    # ... HTMLå†…å®¹ç”Ÿæˆé€»è¾‘
except Exception as e:
    # è®°å½•HTMLå†…å®¹ç”Ÿæˆé”™è¯¯
    self.log_error("HTMLé¡µé¢ç”Ÿæˆé”™è¯¯", str(e), traceback.format_exc())
    # è¿”å›ç®€å•çš„é”™è¯¯é¡µé¢
```

#### å†å²è®°å½•æ¥å£
```python
try:
    # å†å²è®°å½•å¤„ç†é€»è¾‘
    response_data = {
        'success': True,
        'history': [/* å†å²è®°å½•æ•°æ® */],
        'count': 1,
        'status': 'running'
    }
except Exception as e:
    # è®°å½•é”™è¯¯ä¿¡æ¯
    self.log_error("å†å²è®°å½•æ¥å£é”™è¯¯", str(e), traceback.format_exc())
    # è¿”å›é»˜è®¤å†å²è®°å½•æ•°æ®
```

#### é™æ€æ–‡ä»¶å¤„ç†
```python
try:
    # é™æ€æ–‡ä»¶å¤„ç†é€»è¾‘
    if os.path.exists(file_path) and os.path.isfile(file_path):
        # è¿”å›æ–‡ä»¶å†…å®¹
        with open(file_path, 'rb') as file:
            self.wfile.write(file.read())
    else:
        self.send_response(404)
except Exception as e:
    self.log_error("é™æ€æ–‡ä»¶è®¿é—®é”™è¯¯", str(e), traceback.format_exc())
```

## é”™è¯¯æ—¥å¿—æ–‡ä»¶æ ¼å¼

### æ–‡ä»¶ä½ç½®
- è·¯å¾„ï¼š`E:\RAGç³»ç»Ÿ\logs\server_errors.log`
- ç¼–ç ï¼šUTF-8ï¼ˆæ”¯æŒä¸­æ–‡é”™è¯¯ä¿¡æ¯ï¼‰

### æ—¥å¿—æ ¼å¼
```
2025-11-24 21:52:27,123 - ERROR - å†å²è®°å½•æ¥å£é”™è¯¯: Connection refused | è¯¦æƒ…: Traceback (most recent call last):...
2025-11-24 21:52:28,456 - ERROR - HTMLé¡µé¢ç”Ÿæˆé”™è¯¯: Encoding error | è¯¦æƒ…: Traceback (most recent call last):...
```

### é”™è¯¯ç±»å‹åˆ†ç±»
1. **è¿æ¥é”™è¯¯**ï¼š`net::ERR_CONNECTION_REFUSED`ç­‰ç½‘ç»œè¿æ¥é—®é¢˜
2. **æœåŠ¡å™¨å†…éƒ¨é”™è¯¯**ï¼šPythonä»£ç æ‰§è¡Œå¼‚å¸¸
3. **æ–‡ä»¶è®¿é—®é”™è¯¯**ï¼šé™æ€æ–‡ä»¶ä¸å­˜åœ¨æˆ–æƒé™é—®é¢˜
4. **è¯·æ±‚å¤„ç†é”™è¯¯**ï¼šHTTPè¯·æ±‚å¤„ç†å¼‚å¸¸

## æ™ºèƒ½ä½“ç›‘æ§æœºåˆ¶

### ç›‘æ§ç­–ç•¥
1. **å®šæœŸè¯»å–**ï¼šæ™ºèƒ½ä½“å®šæœŸæ£€æŸ¥é”™è¯¯æ—¥å¿—æ–‡ä»¶
2. **é”™è¯¯åˆ†æ**ï¼šè§£æé”™è¯¯ç±»å‹ã€é¢‘ç‡å’Œä¸¥é‡ç¨‹åº¦
3. **çŠ¶æ€åˆ¤æ–­**ï¼šæ ¹æ®é”™è¯¯æƒ…å†µå†³å®šæ˜¯å¦éœ€è¦å¹²é¢„
4. **æŠ¥å‘Šç”Ÿæˆ**ï¼šç”Ÿæˆç³»ç»ŸçŠ¶æ€æŠ¥å‘Š

### ç›‘æ§é¢‘ç‡
- **å®æ—¶ç›‘æ§**ï¼šé”™è¯¯å‘ç”Ÿæ—¶ç«‹å³è®°å½•
- **å®šæœŸæ£€æŸ¥**ï¼šæ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡é”™è¯¯æ—¥å¿—
- **å¼‚å¸¸æŠ¥è­¦**ï¼šè¿ç»­å‡ºç°ç›¸åŒé”™è¯¯æ—¶å‘å‡ºè­¦æŠ¥

### çŠ¶æ€æŠ¥å‘Šæ ¼å¼
```json
{
    "system_status": "normal|warning|error",
    "last_check_time": "2025-11-24 21:52:27",
    "error_count": 3,
    "recent_errors": [
        {
            "type": "è¿æ¥é”™è¯¯",
            "message": "net::ERR_CONNECTION_REFUSED",
            "timestamp": "2025-11-24 21:52:27",
            "frequency": 2
        }
    ],
    "recommendation": "ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œæ— éœ€å¹²é¢„"
}
```

## ä¼˜åŠ¿ä¸ä»·å€¼

### 1. é—®é¢˜å‘ç°åŠæ—¶æ€§
- å‰ç«¯æ§åˆ¶å°é”™è¯¯ä¸å†"åªæœ‰æˆ‘çŸ¥é“"
- æ™ºèƒ½ä½“èƒ½å¤Ÿå®æ—¶æ„ŸçŸ¥ç³»ç»ŸçŠ¶æ€
- é—®é¢˜å‘ç°æ—¶é—´ä»"è¢«åŠ¨ç­‰å¾…"å˜ä¸º"ä¸»åŠ¨ç›‘æ§"

### 2. é”™è¯¯åˆ†ææ·±åº¦
- é”™è¯¯ä¿¡æ¯åŒ…å«å®Œæ•´å †æ ˆè·Ÿè¸ª
- æŒ‰ç±»å‹å’Œä¸¥é‡ç¨‹åº¦åˆ†ç±»
- ä¾¿äºé—®é¢˜å®šä½å’Œè§£å†³

### 3. ç³»ç»Ÿç¨³å®šæ€§
- é”™è¯¯å¤„ç†ä¸ä¼šå¯¼è‡´æœåŠ¡å™¨å´©æºƒ
- å¤‡ç”¨æ–¹æ¡ˆç¡®ä¿åŸºæœ¬åŠŸèƒ½å¯ç”¨
- ä¼˜é›…é™çº§æœºåˆ¶

### 4. æ™ºèƒ½ä½“åä½œ
- æ™ºèƒ½ä½“å¯ä»¥åŸºäºé”™è¯¯æ—¥å¿—åšå‡ºå†³ç­–
- è‡ªåŠ¨åŒ–çš„çŠ¶æ€ç›‘æ§å’ŒæŠ¥å‘Š
- å‡å°‘äººå·¥å¹²é¢„éœ€æ±‚

## æ‰©å±•è®¡åˆ’

### çŸ­æœŸæ”¹è¿›
1. æ·»åŠ é”™è¯¯ç»Ÿè®¡åŠŸèƒ½
2. å®ç°é”™è¯¯è¶‹åŠ¿åˆ†æ
3. å¢åŠ é”™è¯¯çº§åˆ«åˆ’åˆ†ï¼ˆINFO/WARNING/ERROR/CRITICALï¼‰

### é•¿æœŸè§„åˆ’
1. é›†æˆåˆ°ç³»ç»Ÿç›‘æ§é¢æ¿
2. å®ç°é”™è¯¯è‡ªåŠ¨ä¿®å¤æœºåˆ¶
3. å»ºç«‹é”™è¯¯çŸ¥è¯†åº“å’Œè§£å†³æ–¹æ¡ˆåº“

## æ€»ç»“

è¿™å¥—é”™è¯¯æ—¥å¿—è®°å½•æ–¹æ¡ˆå½»åº•è§£å†³äº†"æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ä¸è¢«æ™ºèƒ½ä½“æ„ŸçŸ¥"çš„é—®é¢˜ï¼Œå®ç°äº†ï¼š

- **é”™è¯¯ä¿¡æ¯çš„ç»Ÿä¸€ç®¡ç†**
- **æ™ºèƒ½ä½“çš„çŠ¶æ€æ„ŸçŸ¥èƒ½åŠ›**
- **ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§**
- **é—®é¢˜å‘ç°çš„åŠæ—¶æ€§å’Œå‡†ç¡®æ€§**

é€šè¿‡è¿™å¥—æ–¹æ¡ˆï¼ŒRAGç³»ç»Ÿå…·å¤‡äº†çœŸæ­£çš„è‡ªæˆ‘ç›‘æ§å’Œè‡ªæˆ‘è¯Šæ–­èƒ½åŠ›ï¼Œä¸ºåç»­çš„æ™ºèƒ½ä½“åä½œå’Œç³»ç»Ÿä¼˜åŒ–å¥ å®šäº†åšå®åŸºç¡€ã€‚

## å…¸å‹æ¡ˆä¾‹ï¼šç»Ÿä¸€é”™è¯¯æ„ŸçŸ¥ç³»ç»Ÿ

### é—®é¢˜èƒŒæ™¯
åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°ï¼Œå‰ç«¯JavaScripté”™è¯¯ï¼ˆå¦‚`net::ERR_CONNECTION_REFUSED`ï¼‰åªåœ¨æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºï¼Œæ™ºèƒ½ä½“æ— æ³•æ„ŸçŸ¥è¿™äº›é”™è¯¯ï¼Œå¯¼è‡´é—®é¢˜è¯Šæ–­ä¸å®Œæ•´ã€‚

### è§£å†³æ–¹æ¡ˆï¼šå‰ç«¯+åç«¯é”™è¯¯ç»Ÿä¸€æ”¶é›†

#### 1. å‰ç«¯é”™è¯¯æ•è·æœºåˆ¶
åœ¨<mcfile name="agent_chatbot.html" path="E:\RAGç³»ç»Ÿ\templates\agent_chatbot.html"></mcfile>çš„ChatInterfaceç±»ä¸­å®ç°ï¼š

```javascript
// å‰ç«¯é”™è¯¯æ•è·ç³»ç»Ÿ
initializeErrorHandling() {
    // å…¨å±€é”™è¯¯ç›‘å¬å™¨
    window.addEventListener('error', (event) => {
        this.reportError({
            type: 'JavaScript Error',
            message: event.message,
            url: event.filename,
            stack: event.error?.stack
        });
    });
    
    // Promiseæ‹’ç»ç›‘å¬å™¨
    window.addEventListener('unhandledrejection', (event) => {
        this.reportError({
            type: 'Promise Rejection',
            message: event.reason?.message || 'Unhandled Promise Rejection',
            url: window.location.href,
            stack: event.reason?.stack
        });
    });
    
    // æ‹¦æˆªfetchè¯·æ±‚é”™è¯¯
    this.interceptFetchErrors();
}

// é”™è¯¯ä¸ŠæŠ¥æ–¹æ³•
reportError(errorData) {
    fetch(`${this.apiBase}/error-report`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(errorData)
    }).catch(() => {
        // é”™è¯¯ä¸ŠæŠ¥å¤±è´¥æ—¶é™é»˜å¤„ç†
    });
}
```

#### 2. æœåŠ¡å™¨ç«¯é”™è¯¯æ”¶é›†æ¥å£
åœ¨<mcfile name="start_server.py" path="E:\RAGç³»ç»Ÿ\start_server.py"></mcfile>çš„do_POSTæ–¹æ³•ä¸­æ·»åŠ ï¼š

```python
# å‰ç«¯é”™è¯¯æ”¶é›†æ¥å£
elif path == '/api/error-report':
    content_length = int(self.headers['Content-Length'])
    post_data = self.rfile.read(content_length)
    
    try:
        data = json.loads(post_data.decode('utf-8'))
        
        # è®°å½•å‰ç«¯é”™è¯¯åˆ°æœåŠ¡å™¨æ—¥å¿—
        error_type = data.get('type', 'unknown')
        error_message = data.get('message', 'No message')
        error_url = data.get('url', 'No URL')
        error_stack = data.get('stack', 'No stack trace')
        
        # ç»Ÿä¸€é”™è¯¯æ—¥å¿—æ ¼å¼
        error_log = f"[å‰ç«¯é”™è¯¯] ç±»å‹: {error_type}, æ¶ˆæ¯: {error_message}, URL: {error_url}"
        print(error_log)
        
        # å¦‚æœæœ‰å †æ ˆä¿¡æ¯ï¼Œä¹Ÿæ‰“å°å‡ºæ¥
        if error_stack and error_stack != 'No stack trace':
            print(f"[å‰ç«¯å †æ ˆ] {error_stack}")
        
        # è¿”å›æˆåŠŸå“åº”
        self.send_response(200)
        self.send_header('Content-type', 'application/json; charset=utf-8')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.end_headers()
        
        response = {
            'success': True,
            'message': 'é”™è¯¯å·²è®°å½•',
            'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        }
        
        self.wfile.write(json.dumps(response, ensure_ascii=False).encode('utf-8'))
        
    except Exception as e:
        # é”™è¯¯æ”¶é›†æ¥å£æœ¬èº«çš„é”™è¯¯å¤„ç†
        self.send_response(500)
        self.send_header('Content-type', 'application/json; charset=utf-8')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.end_headers()
        
        error_response = {
            'success': False,
            'message': f'é”™è¯¯æ”¶é›†å¤±è´¥: {str(e)}'
        }
        
        self.wfile.write(json.dumps(error_response, ensure_ascii=False).encode('utf-8'))
```

#### 3. ç¼–ç é—®é¢˜ä¿®å¤
å°†æ‰€æœ‰`self.send_error`è°ƒç”¨æ›¿æ¢ä¸ºæ­£ç¡®çš„UTF-8ç¼–ç æ–¹å¼ï¼š

```python
# ä¿®å¤å‰
self.send_error(500, f"å¤„ç†èŠå¤©è¯·æ±‚å¤±è´¥: {str(e)}")

# ä¿®å¤å
self.send_response(500)
self.send_header('Content-type', 'text/plain; charset=utf-8')
self.end_headers()
error_message = f"å¤„ç†èŠå¤©è¯·æ±‚å¤±è´¥: {str(e)}"
self.wfile.write(error_message.encode('utf-8'))
```

### å®ç°æ•ˆæœ

#### æµ‹è¯•éªŒè¯
é€šè¿‡PowerShellå‘½ä»¤æµ‹è¯•é”™è¯¯æ”¶é›†æ¥å£ï¼š
```powershell
Invoke-RestMethod -Uri "http://127.0.0.1:10808/api/error-report" -Method POST -Headers @{"Content-Type"="application/json"} -Body '{"type":"test","message":"æµ‹è¯•é”™è¯¯æ¶ˆæ¯","url":"http://localhost:10808","stack":"æµ‹è¯•å †æ ˆä¿¡æ¯"}'
```

**å“åº”ç»“æœï¼š**
```json
{
    "success": true,
    "message": "é”™è¯¯å·²è®°å½•",
    "timestamp": "2025-11-24 22:41:19"
}
```

**æœåŠ¡å™¨æ—¥å¿—è¾“å‡ºï¼š**
```
[å‰ç«¯é”™è¯¯] ç±»å‹: test, æ¶ˆæ¯: æµ‹è¯•é”™è¯¯æ¶ˆæ¯, URL: http://localhost:10808
[å‰ç«¯å †æ ˆ] æµ‹è¯•å †æ ˆä¿¡æ¯
[RAGå¯åŠ¨å™¨] "POST /api/error-report HTTP/1.1" 200 -
```

### æ ¸å¿ƒä»·å€¼

1. **å®Œæ•´é”™è¯¯è§†å›¾**ï¼šå‰ç«¯å’Œåç«¯é”™è¯¯ç»Ÿä¸€æ”¶é›†ï¼Œå½¢æˆå®Œæ•´çš„ç³»ç»ŸçŠ¶æ€è§†å›¾
2. **å®æ—¶ç›‘æ§**ï¼šJavaScripté”™è¯¯ã€Promiseæ‹’ç»ã€ç½‘ç»œè¯·æ±‚é”™è¯¯éƒ½èƒ½å®æ—¶ä¸ŠæŠ¥
3. **æ™ºèƒ½ä½“æ„ŸçŸ¥**ï¼šæ™ºèƒ½ä½“å¯ä»¥é€šè¿‡è¯»å–ç»Ÿä¸€æ—¥å¿—æ–‡ä»¶æ„ŸçŸ¥å‰ç«¯å’Œåç«¯çš„æ‰€æœ‰é—®é¢˜
4. **é—®é¢˜å®šä½**ï¼šç»“åˆå‰ç«¯é”™è¯¯å †æ ˆå’Œåç«¯æ—¥å¿—ï¼Œå¿«é€Ÿå®šä½é—®é¢˜æ ¹æº
5. **ç³»ç»Ÿç¨³å®šæ€§**ï¼šé”™è¯¯ä¸ä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒï¼Œä¼˜é›…é™çº§æœºåˆ¶ç¡®ä¿åŸºæœ¬åŠŸèƒ½å¯ç”¨

### ç»éªŒæ€»ç»“

è¿™ä¸ªæ¡ˆä¾‹å±•ç¤ºäº†å¦‚ä½•å°†å‰ç«¯å’Œåç«¯é”™è¯¯ä¿¡æ¯ç»Ÿä¸€æ”¶é›†çš„é‡è¦æ€§ï¼š

- **é—®é¢˜å‘ç°**ï¼šå‰ç«¯é”™è¯¯ä¸å†"éšè—"åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­
- **ç»Ÿä¸€ç®¡ç†**ï¼šæ‰€æœ‰é”™è¯¯ä¿¡æ¯é›†ä¸­å­˜å‚¨ï¼Œä¾¿äºåˆ†æå’Œç›‘æ§
- **æ™ºèƒ½åä½œ**ï¼šæ™ºèƒ½ä½“å¯ä»¥åŸºäºå®Œæ•´çš„é”™è¯¯ä¿¡æ¯åšå‡ºæ›´å‡†ç¡®çš„å†³ç­–
- **æŒç»­æ”¹è¿›**ï¼šé”™è¯¯æ•°æ®ä¸ºç³»ç»Ÿä¼˜åŒ–æä¾›äº†å®è´µçš„æ•°æ®æ”¯æŒ

é€šè¿‡è¿™ä¸ªç»Ÿä¸€é”™è¯¯æ„ŸçŸ¥ç³»ç»Ÿï¼ŒRAGç³»ç»ŸçœŸæ­£å®ç°äº†ç«¯åˆ°ç«¯çš„é”™è¯¯ç›‘æ§å’Œæ™ºèƒ½è¯Šæ–­èƒ½åŠ›ã€‚