# 代码实现师专用数据库设计方案 v1
<!-- @self-expose: {"id": "code_index_design_doc", "name": "代码实现师专用数据库设计方案", "type": "doc", "version": "1.0.0", "needs": {"deps": ["agent_tool_integration", "tools.chat_tools", "component_graph", "self_exposures", "vector_database(optional)"], "resources": ["data/code_index_db.sqlite"]}, "provides": {"capabilities": ["结构化代码索引方案", "角色与权限策略", "数据库模式", "更新策略", "检索接口"], "methods": {"code_index_build": {"signature": "(scope: str, mode: full|incremental) -> Report"}, "code_symbol_search": {"signature": "(query: str, filters: Dict) -> Results"}}}} -->

### 背景与动机
- **问题**: 代码检索依赖向量化易产生语义漂移，且代码动态变更导致索引老化。
- **目标**: 为代码实现师提供稳定、可增量更新的结构化索引库，并共享只读给系统管家，用于任务编排与上下文加载。

### 角色与权限
- **代码实现师（write）**: 构建/重建索引、增量更新、结构一致性修复。
- **系统管家（read-only）**: 按组件→文件→符号的层级导航与任务上下文装载。
- **其他角色**: 不直接访问源码索引，避免数据污染。

### 架构目标
- **结构化优先**: 以文件/符号/关系为核心，不强依赖向量；注释/文档可选语义补充。
- **增量/夜间批量**: 保存或合并事件触发增量，夜间进行全量校验与重建。
- **图谱联动**: 与 `component_graph.json` / `self_exposures.json` 同步，保证 owner_component/depends_on/协议版本一致性。

### 数据库模式（建议使用 SQLite: data/code_index_db.sqlite）
```sql
-- 文件表
CREATE TABLE IF NOT EXISTS files (
  file_path TEXT PRIMARY KEY,
  file_hash TEXT NOT NULL,
  owner_component TEXT,
  protocol_version TEXT,
  last_modified DATETIME NOT NULL
);

-- 符号表（类/函数/变量/模块）
CREATE TABLE IF NOT EXISTS symbols (
  symbol_id TEXT PRIMARY KEY,
  file_path TEXT NOT NULL,
  symbol_name TEXT NOT NULL,
  symbol_type TEXT NOT NULL, -- class|function|variable|module
  signature TEXT,
  docstring TEXT,
  start_line INTEGER,
  end_line INTEGER,
  FOREIGN KEY(file_path) REFERENCES files(file_path)
);

-- 关系表（调用/引用/继承/实现等）
CREATE TABLE IF NOT EXISTS relations (
  source_symbol_id TEXT NOT NULL,
  relation_type TEXT NOT NULL, -- calls|references|extends|implements
  target_symbol_id TEXT NOT NULL,
  PRIMARY KEY (source_symbol_id, relation_type, target_symbol_id)
);

-- 组件表（与自曝光协议联动）
CREATE TABLE IF NOT EXISTS components (
  component_id TEXT PRIMARY KEY,
  name TEXT,
  depends_on TEXT,  -- JSON
  provides TEXT      -- JSON
);

CREATE INDEX IF NOT EXISTS idx_symbols_file ON symbols(file_path);
CREATE INDEX IF NOT EXISTS idx_symbols_name ON symbols(symbol_name);
CREATE INDEX IF NOT EXISTS idx_relations_source ON relations(source_symbol_id);
CREATE INDEX IF NOT EXISTS idx_relations_target ON relations(target_symbol_id);
```

### 构建与更新策略
- **增量更新**: 基于 `last_modified` 或 git diff 只解析变更文件；失败写入“泡泡”并标注原因。
- **夜间全量**: 重算 `file_hash/符号/关系`，校验与图谱/自曝光一致性；不一致触发二级报错。
- **忽略清单**: 排除生成物、二进制、密钥文件与非源码资产。

### 检索接口（工具入口占位）
- **code_index_build(scope, mode)**: 构建索引（scope: 路径或组件；mode: full|incremental）。
- **code_symbol_search(query, filters)**: 精确/关系检索（按符号名/类型/文件/组件；支持关系展开：calls/called_by/implements/extends）。
- **组合导航**: 按 `owner_component → files → symbols → relations` 输出层级视图。

### 与现有系统的联动
- **知识图谱**: relations 可投影至 `component_graph.json` 的边；files 与 components 保持 contains/depends_on 同步。
- **自曝光协议**: 从源文件头部第2行读取 id/name/type/version/needs/provides，落至 components/文件扩展字段。
- **评估与门禁**: 实现师写入前门禁不变；系统管家仅使用只读导航上下文。

### 风险与缓解
- **索引老化**: 增量+夜间全量，失败透传“泡泡”，人工复核。
- **语义不足**: 保留注释/文档可选向量补充，但不将向量用于源码主体检索排序。
- **数据污染**: 权限隔离，构建工具只解析 `src/` 源码，严格忽略清单。

### 里程碑（建议）
- **M1（试点）**: 10个核心文件函数级索引；度量命中率/误召率/耗时。
- **M2（联动）**: 接入图谱/自曝光标签；完成增量与夜间全量任务。
- **M3（工具化）**: 在工具集成器新增 `code_index_build` / `code_symbol_search` 入口，并开放给系统管家只读。

### 附录：一致性校验清单（示例）
- **协议指纹一致**: 文件的自曝光协议版本与组件表一致。
- **图谱边一致**: contains/depends_on 与 relations 映射一致。
- **重复实现**: 同符号名不同签名需提示复核（重构建议）。
- **更新成功率**: 增量构建与夜间全量的成功率≥95%，失败逐项泡泡记录。
