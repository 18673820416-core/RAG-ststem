<!DOCTYPE html>
<!-- @self-expose: {"id": "start_page", "name": "Start Page", "type": "frontend", "version": "1.0.1", "needs": {"deps": [], "resources": []}, "provides": {"capabilities": ["ç³»ç»Ÿå¯åŠ¨é¡µé¢", "ç“®åŸå‰å“¨å…¥å£"]}} -->
<html lang="zh-CN">
<head>
    <!-- 
    RAGæ™ºèƒ½ç³»ç»Ÿ - ç»Ÿä¸€äº¤äº’å¹³å°å¯åŠ¨é¡µé¢
    ===================================
    
    é¡µé¢å®šä½ï¼š
    - è¿™æ˜¯RAGç³»ç»Ÿçš„ç»Ÿä¸€äº¤äº’å¹³å°å…¥å£é¡µé¢
    - æ”¯æŒä¸¤ç§äº¤äº’æ¨¡å¼ï¼šç®€æ˜“èŠå¤©æœºå™¨äººå’Œå¤šæ™ºèƒ½ä½“äº¤äº’
    - é‡‡ç”¨"æ— é—¨å³å®‰å…¨"è®¾è®¡ç†å¿µï¼ˆç«¯å£å³å¯†ç ï¼‰
    
    åŠŸèƒ½è¯´æ˜ï¼š
    1. ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ - å®æ—¶æ˜¾ç¤ºåç«¯æœåŠ¡çŠ¶æ€
    2. äº¤äº’æ¨¡å¼é€‰æ‹© - æ”¯æŒä¸¤ç§æ¨¡å¼çš„è‡ªç”±åˆ‡æ¢
    3. åç«¯æœåŠ¡å¯åŠ¨ - ç‚¹å‡»æŒ‰é’®å¯åŠ¨å®Œæ•´ç³»ç»Ÿ
    4. é”™è¯¯æŠ¥å‘Š - å‰ç«¯é”™è¯¯æ—¥å¿—è®°å½•æœºåˆ¶
    
    è®¿é—®è·¯å¾„ï¼š
    - ç›´æ¥è®¿é—®: http://localhost:10808
    - æ¨¡å¼é€‰æ‹©ï¼šé€šè¿‡å¯¼èˆªèœå•é€‰æ‹©äº¤äº’æ¨¡å¼
    
    æ³¨æ„ï¼šè¿™æ˜¯ç»Ÿä¸€çš„äº¤äº’å¹³å°ï¼Œæ”¯æŒåŒæ¨¡å¼åˆ‡æ¢ã€‚
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAGæ™ºèƒ½ç³»ç»Ÿ - ç»Ÿä¸€äº¤äº’å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .launch-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .mode-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .mode-button.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-color: transparent;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .logo {
            font-size: 3em;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .launch-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .launch-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .launch-button:active {
            transform: translateY(0);
        }

        .status {
            margin-top: 20px;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .security-note {
            margin-top: 30px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 0.9em;
        }

        /* ç™»å½•è¡¨å•æ ·å¼ */
        .login-form {
            background: rgba(255, 255, 255, 0.15);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-form h3 {
            margin-bottom: 20px;
            font-weight: 300;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.95em;
            opacity: 0.9;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: rgba(79, 172, 254, 0.8);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .error-message {
            color: #ff6b6b;
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .login-info {
            margin-top: 15px;
            font-size: 0.85em;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="launch-container">
        <div class="logo">ğŸš€</div>
        <h1>RAGæ™ºèƒ½ç³»ç»Ÿ</h1>
        <div class="subtitle">å‰ç«¯å¯åŠ¨åç«¯ Â· æ— é—¨å³å®‰å…¨</div>
        
        <div class="mode-selector">
            <div class="mode-button active" data-target="/templates/chatroom.html">å¤šæ™ºèƒ½ä½“èŠå¤©å®¤</div>
            <div class="mode-button" data-target="/templates/base_agent_chat.html">åŸºç±»æ™ºèƒ½ä½“äº¤äº’</div>
        </div>
        
        <!-- ç™»å½•è¡¨å• -->
        <div class="login-form">
            <h3>ğŸ‘¤ ç”¨æˆ·ç™»å½•</h3>
            <div class="form-group">
                <label for="username">ç”¨æˆ·å</label>
                <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                <div class="error-message" id="usernameError">è¯·è¾“å…¥æœ‰æ•ˆçš„ç”¨æˆ·å</div>
            </div>
            <div class="form-group">
                <label for="password">8ä½æ•°å¯†ç </label>
                <input type="password" id="password" placeholder="è¯·è¾“å…¥8ä½æ•°å­—å¯†ç " maxlength="8" required>
                <div class="error-message" id="passwordError">å¯†ç å¿…é¡»ä¸º8ä½æ•°å­—</div>
            </div>
            <div class="login-info">
                ğŸ’¡ å¯†ç ä¸º8ä½æ•°å­—ï¼Œç”¨äºç³»ç»Ÿèº«ä»½éªŒè¯
            </div>
        </div>
        
        <button class="launch-button" onclick="startBackend()">ğŸš€ è¿›å…¥ç³»ç»Ÿ</button>
        
        <div class="status" id="status">è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œç„¶åç‚¹å‡»è¿›å…¥ç³»ç»Ÿ</div>
        
        <div class="security-note">
            ğŸ’¡ ç³»ç»Ÿè¯´æ˜<br>
            ğŸ” æœ¬ç³»ç»Ÿé‡‡ç”¨é›†æˆå¼æœåŠ¡å™¨è®¾è®¡ï¼Œå·²åŒ…å«ï¼š<br>
            ğŸš€ å¤šæ¨¡æ€èåˆå¼•æ“ã€æ¨ç†å¼•æ“ã€å¤šæ™ºèƒ½ä½“èŠå¤©å®¤ã€RAGæ£€ç´¢å¢å¼ºç”Ÿæˆ<br>
            ğŸ’¬ è¯·å…ˆé€‰æ‹©äº¤äº’æ¨¡å¼ï¼Œç„¶åç‚¹å‡»è¿›å…¥ç³»ç»Ÿ
        </div>
    </div>

    <script>
        let selectedMode = '/templates/chatroom.html';
        
        // æ¨¡å¼é€‰æ‹©åŠŸèƒ½
        function selectMode(button) {
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
            document.querySelectorAll('.mode-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ·»åŠ activeç±»åˆ°å½“å‰æŒ‰é’®
            button.classList.add('active');
            
            // æ›´æ–°é€‰ä¸­çš„æ¨¡å¼
            selectedMode = button.getAttribute('data-target');
            
            // æ›´æ–°çŠ¶æ€æç¤º
            const status = document.getElementById('status');
            status.textContent = `å·²é€‰æ‹©: ${button.textContent}ï¼Œè¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç åç‚¹å‡»è¿›å…¥ç³»ç»Ÿ`;
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ¨¡å¼é€‰æ‹©
        document.addEventListener('DOMContentLoaded', function() {
            // ä¸ºæ¨¡å¼æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.mode-button').forEach(button => {
                button.addEventListener('click', function() {
                    selectMode(this);
                });
            });
            
            // ä¸ºè¡¨å•è¾“å…¥æ·»åŠ å®æ—¶éªŒè¯
            document.getElementById('username').addEventListener('input', validateUsername);
            document.getElementById('password').addEventListener('input', validatePassword);
        });
        
        // éªŒè¯ç”¨æˆ·å
        function validateUsername() {
            const username = document.getElementById('username').value;
            const errorElement = document.getElementById('usernameError');
            
            if (username.trim().length < 2) {
                errorElement.classList.add('show');
                return false;
            } else {
                errorElement.classList.remove('show');
                return true;
            }
        }
        
        // éªŒè¯å¯†ç 
        function validatePassword() {
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('passwordError');
            
            const passwordRegex = /^\d{8}$/;
            if (!passwordRegex.test(password)) {
                errorElement.classList.add('show');
                return false;
            } else {
                errorElement.classList.remove('show');
                return true;
            }
        }
        
        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°localStorage
        function saveUserInfo(username, password) {
            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨äºå‘é‡åº“çš„äººç‰©ç»´ç»´åº¦ä¿¡æ¯è¡¥å…¨
            localStorage.setItem('rag_user_info', JSON.stringify({
                username: username,
                timestamp: new Date().toISOString()
            }));
        }
        
        async function startBackend() {
            const button = document.querySelector('.launch-button');
            const status = document.getElementById('status');
            
            // æ­¥éª¤1: éªŒè¯è¡¨å•
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!validateUsername() || !validatePassword()) {
                status.textContent = 'âŒ è¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯ï¼Œç”¨æˆ·åå’Œå¯†ç æ ¼å¼ä¸æ­£ç¡®';
                return;
            }
            
            button.disabled = true;
            button.textContent = 'ğŸš€ å¯åŠ¨ä¸­...';
            status.textContent = 'æ­£åœ¨å¯åŠ¨ç³»ç»ŸåŠŸèƒ½ï¼Œè¯·ç¨å€™...';
            
            try {
                // æ­¥éª¤2: ä¿å­˜ç”¨æˆ·ä¿¡æ¯
                saveUserInfo(username, password);
                status.textContent = 'âœ… ç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜ï¼Œæ­£åœ¨å¯åŠ¨RAGä¸»æœåŠ¡å™¨...';
                
                // æ­¥éª¤3: å¯åŠ¨RAGä¸»æœåŠ¡å™¨ï¼ˆå…³é”®ï¼è·å–åŠ¨æ€ç«¯å£ï¼‰
                const startResponse = await fetch('/api/start_backend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        mode: selectedMode,
                        username: username
                    })
                });
                
                if (!startResponse.ok) {
                    throw new Error('å¯åŠ¨RAGæœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—');
                }
                
                const startData = await startResponse.json();
                console.log('å¯åŠ¨å“åº”:', startData);
                
                if (startData.status === 'error') {
                    throw new Error('å¯åŠ¨å¤±è´¥: ' + (startData.message || 'æœªçŸ¥é”™è¯¯'));
                }
                
                // RAGä¸»æœåŠ¡å™¨å·²å¼€å§‹å¯åŠ¨ï¼ŒåŠ¨æ€ç«¯å£ç”±é™æ€æœåŠ¡å™¨ç®¡ç†
                const dynamicPort = startData.port;
                console.log('ğŸ² åŠ¨æ€ç«¯å£(ç”±å‰å“¨ç®¡ç†ï¼Œä»…ç”¨äºè°ƒè¯•):', dynamicPort);
                
                status.textContent = `âœ… RAGæœåŠ¡å™¨æ­£åœ¨å¯åŠ¨ï¼Œé¢„è®¡éœ€è¦5-10ç§’...`;
                
                // æ­¥éª¤4: è½®è¯¢æ£€æŸ¥RAGæœåŠ¡å™¨çŠ¶æ€ï¼ˆé€šè¿‡é™æ€æœåŠ¡å™¨ä»£ç†ï¼‰
                let checkCount = 0;
                const maxChecks = 30; // æœ€å¤šæ£€æŸ¥30æ¬¡ï¼ˆ30ç§’ï¼‰
                
                const checkInterval = setInterval(async () => {
                    checkCount++;
                    
                    try {
                        // é€šè¿‡é™æ€æœåŠ¡å™¨æ£€æŸ¥RAGä¸»æœåŠ¡å™¨çŠ¶æ€
                        const statusResponse = await fetch('/api/status', {
                            method: 'GET',
                            cache: 'no-cache'
                        });
                        
                        if (statusResponse.ok) {
                            const statusData = await statusResponse.json();
                            
                            if (statusData.status === 'running') {
                                // RAGæœåŠ¡å™¨å·²å°±ç»ª
                                clearInterval(checkInterval);
                                
                                const modeName = document.querySelector('.mode-button.active').textContent;
                                status.textContent = `âœ… ç³»ç»Ÿå·²å°±ç»ªï¼æ­£åœ¨è·³è½¬åˆ°${modeName}...`;
                                
                                // ä½¿ç”¨ç›¸å¯¹è·¯å¾„è·³è½¬åˆ°ç›®æ ‡æ¨¡å¼é¡µé¢ï¼ˆç”±é™æ€æœåŠ¡å™¨æ‰˜ç®¡ï¼‰
                                setTimeout(() => {
                                    console.log(`å‡†å¤‡è·³è½¬åˆ°: ${selectedMode}`);
                                    window.location.href = selectedMode;
                                }, 1000);
                            } else {
                                // ç»§ç»­ç­‰å¾…
                                status.textContent = `â³ RAGæœåŠ¡å™¨å¯åŠ¨ä¸­... (${checkCount}/${maxChecks})`;
                            }
                        } else {
                            // ç»§ç»­ç­‰å¾…
                            status.textContent = `â³ RAGæœåŠ¡å™¨å¯åŠ¨ä¸­... (${checkCount}/${maxChecks})`;
                        }
                    } catch (e) {
                        // RAGæœåŠ¡å™¨è¿˜æœªå“åº”ï¼Œç»§ç»­ç­‰å¾…
                        status.textContent = `â³ RAGæœåŠ¡å™¨å¯åŠ¨ä¸­... (${checkCount}/${maxChecks})`;
                        console.log('ç­‰å¾…RAGæœåŠ¡å™¨å“åº”...', e.message);
                    }
                    
                    // è¶…æ—¶å¤„ç†
                    if (checkCount >= maxChecks) {
                        clearInterval(checkInterval);
                        throw new Error('RAGæœåŠ¡å™¨å¯åŠ¨è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æ—¥å¿—');
                    }
                }, 1000); // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
                
            } catch (error) {
                status.textContent = 'âŒ å¯åŠ¨å¤±è´¥: ' + error.message;
                button.disabled = false;
                button.textContent = 'ğŸ”¥ é‡æ–°å¯åŠ¨';
                
                // è®°å½•é”™è¯¯åˆ°åç«¯
                try {
                    await fetch('/api/error-report', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            error: error.message,
                            stack: error.stack,
                            timestamp: new Date().toISOString(),
                            context: 'start.html - startBackend'
                        })
                    });
                } catch (e) {
                    console.error('é”™è¯¯æŠ¥å‘Šå‘é€å¤±è´¥:', e);
                }
                
                // è®°å½•é”™è¯¯åˆ°æ§åˆ¶å°
                console.error('ç³»ç»Ÿå¯åŠ¨é”™è¯¯:', error);
            }
        }
        
        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkStatus() {
            try {
                const response = await fetch('/api/health');
                const status = await response.json();
                document.getElementById('status').innerHTML = 
                    `<span style="color: #4CAF50;">âœ… ç³»ç»ŸçŠ¶æ€: ${status.status}</span><br>` +
                    `<span style="opacity: 0.8;">ğŸ• æ—¶é—´: ${status.timestamp}</span><br>` +
                    `<span style="opacity: 0.8;">ğŸ’¬ æ¶ˆæ¯: ${status.message}</span>`;
            } catch (error) {
                console.log('çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                document.getElementById('status').innerHTML = 
                    '<span style="color: #ff9800;">âš ï¸ ç³»ç»ŸçŠ¶æ€: è¿æ¥ä¸­...</span>';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', checkStatus);
    </script>
</body>
</html>