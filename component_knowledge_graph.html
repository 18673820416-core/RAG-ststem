<!-- @self-expose: {"id": "component_knowledge_graph", "name": "Component Knowledge Graph", "type": "frontend", "version": "1.0.0", "needs": {"deps": [], "resources": []}, "provides": {"capabilities": ["组件知识图谱可视化"]}} -->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>组件知识图谱</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f5f5f5; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 300px; background-color: #fff; border-right: 1px solid #ddd; padding: 20px; overflow-y: auto; }
        .graph-container { flex: 1; position: relative; }
        #graph { width: 100%; height: 100%; }
        .node { cursor: pointer; }
        .node circle { stroke: #fff; stroke-width: 2px; }
        .node text { font-size: 12px; text-anchor: middle; pointer-events: none; }
        .link { stroke: #999; stroke-opacity: 0.6; stroke-width: 1.5px; }
        .node-type-api { fill: #1f77b4; }
        .node-type-service { fill: #2ca02c; }
        .node-type-component { fill: #ff7f0e; }
        .node-type-tool { fill: #9467bd; }
        .info-panel { background-color: #fff; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .info-panel h3 { margin-top: 0; color: #333; }
        .info-panel p { margin: 5px 0; font-size: 14px; }
        .capabilities { margin-top: 10px; }
        .capability { display: inline-block; background-color: #e8f4f8; color: #1f77b4; padding: 3px 8px; border-radius: 12px; font-size: 12px; margin: 2px; }
        .legend { margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; }
        .legend-item { display: flex; align-items: center; margin: 5px 0; }
        .legend-color { width: 15px; height: 15px; border-radius: 50%; margin-right: 8px; }
        .legend-text { font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>组件知识图谱</h2>
            <div class="info-panel">
                <h3>组件信息</h3>
                <p id="node-name">点击节点查看详情</p>
                <p id="node-type"></p>
                <p id="node-version"></p>
                <div class="capabilities" id="node-capabilities"></div>
            </div>
            <div class="legend">
                <h3>图例</h3>
                <div class="legend-item"><div class="legend-color" style="background-color: #1f77b4;"></div><div class="legend-text">API</div></div>
                <div class="legend-item"><div class="legend-color" style="background-color: #2ca02c;"></div><div class="legend-text">Service</div></div>
                <div class="legend-item"><div class="legend-color" style="background-color: #ff7f0e;"></div><div class="legend-text">Component</div></div>
                <div class="legend-item"><div class="legend-color" style="background-color: #9467bd;"></div><div class="legend-text">Tool</div></div>
            </div>
        </div>
        <div class="graph-container">
            <svg id="graph"></svg>
        </div>
    </div>

    <script>
        // 组件数据
        const nodes = [{"id": "generate_component_graph", "name": "组件知识图谱生成器", "type": "tool", "version": "1.0.0", "capabilities": ["组件知识图谱生成", "D3.js可视化", "依赖关系分析", "交互式图谱展示"]}, {"id": "self_exposure_parser", "name": "自我声明解析器", "type": "service", "version": "1.0.0", "capabilities": ["自我声明解析", "多文件扫描", "声明统一管理", "JSON格式输出", "命令行工具支持"]}, {"id": "api_chatroom", "name": "多智能体聊天室API", "type": "api", "version": "1.0.0", "capabilities": ["多智能体交互", "聊天历史管理", "实时消息发送"]}, {"id": "agent_conversation_window", "name": "智能体独立对话窗口", "type": "component", "version": "1.0.0", "capabilities": ["独立理解空间管理", "上下文管理与压缩", "记忆重构", "逻辑完整性检查", "自我叙事生成", "香农信息熵分析", "静默广播消息处理", "人物维度信息管理", "对话历史管理", "交互模式分析"]}, {"id": "agent_discovery_engine", "name": "智能体自动发现引擎", "type": "service", "version": "1.0.0", "capabilities": ["智能体自动发现", "工具自动发现", "组件注册", "工具审核提交", "发现结果生成", "自动注册代码生成"]}, {"id": "agent_manager", "name": "智能体管理器", "type": "service", "version": "1.0.0", "capabilities": ["智能体统一管理", "自动发现机制", "智能体注册", "请求路由", "工作流执行", "临时智能体创建", "智能体状态监控", "工作流历史记录"]}, {"id": "agent_tool_integration", "name": "智能体工具集成器", "type": "component", "version": "1.0.0", "capabilities": ["工具初始化与管理", "工具调用", "多模态引擎集成", "认知引擎集成", "工具状态监控", "工具注册", "工具实例获取", "工具映射"]}, {"id": "base_agent", "name": "统一智能体基类", "type": "component", "version": "1.0.0", "capabilities": ["智能体基础框架", "统一记忆管理", "工具集成", "工作日记系统", "定时任务管理", "系统提示词管理", "记忆重构和整理", "记忆共享机制", "自动日志记录", "智能体响应生成"]}, {"id": "llm_client_enhanced", "name": "增强版LLM客户端", "type": "service", "version": "1.0.0", "capabilities": ["多LLM提供商支持", "聊天补全", "智能文本切片", "API密钥管理", "请求重试机制", "限流处理"]}, {"id": "mention_parser", "name": "@机制解析器", "type": "component", "version": "1.0.0", "capabilities": ["@提及解析", "智能体名称自动补全", "自定义名称支持", "智能体信息管理", "消息处理"]}, {"id": "mesh_database_interface", "name": "网状思维数据库接口", "type": "service", "version": "1.0.0", "capabilities": ["增强记忆存储", "网状思维搜索", "知识图谱构建", "重复记忆检测", "多维度关联分析", "动态记忆纳入", "系统统计信息"]}, {"id": "mesh_thought_engine", "name": "网状思维引擎", "type": "service", "version": "1.0.0", "capabilities": ["思维节点存储", "相似思维查找", "思维关联构建", "隐藏关系发现", "思维网络可视化", "思维连续性构建", "网络赋能", "查重统计", "持久化存储", "动态关系强度计算"]}, {"id": "multi_agent_chatroom", "name": "多智能体聊天室核心服务", "type": "service", "version": "1.0.0", "capabilities": ["动态智能体管理", "独立对话窗口", "智能路由机制", "交互模式分析", "方法论洞察生成", "静默广播", "历史记录管理", "智能体繁殖支持"]}, {"id": "vector_database", "name": "向量数据库", "type": "service", "version": "1.0.0", "capabilities": ["记忆单元管理", "向量存储", "多条件搜索", "向量相似度排序", "时间范围查询", "统计信息生成"]}];
        const links = [{"source": "api_chatroom", "target": "multi_agent_chatroom"}, {"source": "api_chatroom", "target": "agent_manager"}, {"source": "api_chatroom", "target": "llm_client_enhanced"}, {"source": "agent_conversation_window", "target": "agent_tool_integration"}, {"source": "agent_discovery_engine", "target": "base_agent"}, {"source": "agent_manager", "target": "agent_discovery_engine"}, {"source": "agent_tool_integration", "target": "mesh_thought_engine"}, {"source": "base_agent", "target": "agent_tool_integration"}, {"source": "mesh_database_interface", "target": "vector_database"}, {"source": "mesh_database_interface", "target": "mesh_thought_engine"}, {"source": "multi_agent_chatroom", "target": "agent_conversation_window"}, {"source": "multi_agent_chatroom", "target": "mention_parser"}, {"source": "multi_agent_chatroom", "target": "agent_discovery_engine"}, {"source": "multi_agent_chatroom", "target": "agent_manager"}, {"source": "multi_agent_chatroom", "target": "vector_database"}, {"source": "multi_agent_chatroom", "target": "mesh_database_interface"}];
        
        // 设置SVG尺寸
        const svg = d3.select("#graph");
        const width = svg.node().clientWidth;
        const height = svg.node().clientHeight;
        
        // 创建力导向图模拟
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(30));
        
        // 创建箭头标记
        svg.append("defs").selectAll("marker")
            .data(["arrow"])
            .enter().append("marker")
            .attr("id", d => d)
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 25)
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("fill", "#999");
        
        // 创建连线
        const link = svg.append("g")
            .selectAll("line")
            .data(links)
            .enter().append("line")
            .attr("class", "link")
            .attr("marker-end", "url(#arrow)");
        
        // 创建节点组
        const node = svg.append("g")
            .selectAll(".node")
            .data(nodes)
            .enter().append("g")
            .attr("class", "node")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));
        
        // 添加节点圆圈
        node.append("circle")
            .attr("r", 20)
            .attr("class", d => `node-type-${d.type}`);
        
        // 添加节点标签
        node.append("text")
            .attr("dy", 35)
            .text(d => d.name);
        
        // 节点点击事件
        node.on("click", function(event, d) {
            d3.select("#node-name").text(d.name);
            d3.select("#node-type").text(`类型: ${d.type}`);
            d3.select("#node-version").text(`版本: ${d.version}`);
            
            const capabilitiesDiv = d3.select("#node-capabilities");
            capabilitiesDiv.selectAll(".capability").remove();
            
            d.capabilities.forEach(cap => {
                capabilitiesDiv.append("div")
                    .attr("class", "capability")
                    .text(cap);
            });
        });
        
        // 更新模拟
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
            
            node
                .attr("transform", d => `translate(${d.x},${d.y})`);
        });
        
        // 拖拽函数
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        
        // 窗口大小调整
        window.addEventListener("resize", function() {
            const newWidth = svg.node().clientWidth;
            const newHeight = svg.node().clientHeight;
            
            simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2));
            simulation.alpha(0.3).restart();
        });
    </script>
</body>
</html>
