<!DOCTYPE html>
<!-- @self-expose: {"id": "multi_agent_chatroom", "name": "Multi-Agent Chatroom Interface", "type": "frontend", "version": "1.0.3", "needs": {"deps": ["stable_start_server", "multi_agent_chatroom"], "endpoints": [{"path": "/api/chatroom/message", "method": "POST"}, {"path": "/api/chatroom/history", "method": "GET"}, {"path": "/api/chatroom/status", "method": "GET"}]}, "provides": {"capabilities": ["å¤šæ™ºèƒ½ä½“èŠå¤©å®¤ç•Œé¢", "æ™ºèƒ½ä½“åˆ—è¡¨æ˜¾ç¤º", "æ–¹æ³•è®ºæ´å¯Ÿ", "å·¥å…·ä½¿ç”¨è·Ÿè¸ª", "æ–‡ä»¶æ‹–æ‹½ä¸Šä¼ "]}} -->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šæ™ºèƒ½ä½“èŠå¤©å®¤ - å¾®ä¿¡å¼æ™ºèƒ½ä½“åä½œå¹³å°</title>
    <style>
        html, body, * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .chatroom-container {
            width: 100vw; /* å®Œå…¨å æ»¡è§†çª—å®½åº¦ */
            height: 100vh; /* å®Œå…¨å æ»¡è§†çª—é«˜åº¦ */
            margin: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0; /* ç§»é™¤åœ†è§’ */
            box-shadow: none; /* ç§»é™¤é˜´å½± */
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(90deg, #4CAF50, #2196F3);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            flex: 1; /* å æ®å‰©ä½™ç©ºé—´ï¼Œç¡®ä¿å¡«æ»¡æ•´ä¸ªå®¹å™¨ */
            min-height: 0; /* è§£å†³flexå­å…ƒç´ çš„æœ€å°é«˜åº¦é—®é¢˜ */
        }

        .chat-area {
            flex: 6; /* å æ®ä¸»è¦ç©ºé—´ */
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
            min-height: 0; /* è§£å†³flexå­å…ƒç´ çš„æœ€å°é«˜åº¦é—®é¢˜ */
        }

        .messages-container {
            flex: 1;
            padding: 15px 25px; /* å·¦å³å†…è¾¹è·å¢åŠ ï¼Œä¸Šä¸‹å†…è¾¹è·å‡å° */
            overflow-y: auto;
            min-height: 0; /* è§£å†³flexå­å…ƒç´ çš„æœ€å°é«˜åº¦é—®é¢˜ */
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 10px;
            max-width: 90%; /* ä»80%å¢å¤§åˆ°90%ï¼Œæ˜¾ç¤ºæ›´å¤šå†…å®¹ */
            animation: fadeIn 0.3s ease-in;
        }

        .user-message {
            background: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }

        .agent-message {
            background: #f5f5f5;
            margin-right: auto;
            border-bottom-left-radius: 0;
        }

        .architect-message {
            border-left: 4px solid #4CAF50;
        }

        .evaluator-message {
            border-left: 4px solid #FF9800;
        }

        .implementer-message {
            border-left: 4px solid #2196F3;
        }

        .system-message {
            background: #fff3cd;
            text-align: center;
            margin: 10px auto;
            max-width: 90%;
            border-left: 4px solid #ffc107;
        }

        .methodology-insight {
            background: #d4edda;
            border-left: 4px solid #28a745;
            margin: 15px auto;
            max-width: 90%;
            font-style: italic;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .sender {
            font-weight: bold;
            font-size: 0.9em;
        }

        .timestamp {
            font-size: 0.8em;
            color: #666;
        }

        .message-content {
            font-size: 1em;
            line-height: 1.4;
        }

        .input-area {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            background: #f8f9fa;
            position: relative;
        }

        .input-group {
            display: flex;
            gap: 10px;
            position: relative;
            flex-direction: column;
        }

        .input-with-tools {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        #messageInput {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
            min-height: 120px;
            resize: vertical;
            max-height: 300px;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }

        #messageInput:focus {
            border-color: #2196F3;
        }

        /* æ–‡ä»¶æ‹–æ‹½ä¸Šä¼ æ ·å¼ */
        .drag-drop-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .drag-drop-area.dragover {
            border-color: #2196F3;
            background-color: #e3f2fd;
        }

        .file-upload-tools {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .upload-btn {
            padding: 8px 15px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            background: #e0e0e0;
        }

        .hidden {
            display: none;
        }

        #sendButton {
            padding: 12px 25px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        #sendButton:hover {
            background: #1976D2;
        }

        #sendButton:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* @æœºåˆ¶ç›¸å…³æ ·å¼ */
        .mention-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 12px;
            font-weight: bold;
            margin: 0 2px;
        }

        .agent-mention {
            background: #4caf50;
            color: white;
        }

        .mention-popup {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .mention-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .mention-item:hover {
            background: #f5f5f5;
        }

        .mention-item:last-child {
            border-bottom: none;
        }

        .mention-item.active {
            background: #e3f2fd;
        }

        .mention-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #2196F3;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }

        .mention-info {
            display: flex;
            align-items: center;
        }

        .mention-name {
            font-weight: bold;
            margin-right: 8px;
        }

        .mention-role {
            color: #666;
            font-size: 0.9em;
        }

        /* æ™ºèƒ½ä½“é€‰æ‹©å¼¹çª— */
        .agent-select-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
            z-index: 2000;
            display: none;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            font-size: 1.5em;
        }

        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .agent-option {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .agent-option:hover {
            border-color: #2196F3;
            background: #f8f9fa;
        }

        .agent-option.selected {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .agent-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        .modal-btn.primary {
            background: #2196F3;
            color: white;
        }

        .modal-btn.secondary {
            background: #f5f5f5;
            color: #333;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            display: none;
        }

        /* æ™ºèƒ½ä½“è®¾ç½®å¼¹çª— */
        .agent-settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
            z-index: 2000;
            display: none;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .settings-tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .settings-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .settings-tab.active {
            border-bottom-color: #2196F3;
            color: #2196F3;
        }

        .settings-content {
            margin-bottom: 20px;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .settings-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            margin-bottom: 10px;
        }

        .settings-input:focus {
            border-color: #2196F3;
            outline: none;
        }

        .settings-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* æ™ºèƒ½ä½“å¡ç‰‡æ ·å¼ */
        .agent-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .agent-card:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .agent-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .agent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
            margin-right: 15px;
        }

        .agent-details {
            flex: 1;
        }

        .agent-nickname {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .agent-role {
            color: #666;
            font-size: 0.9em;
        }

        .agent-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-active {
            background: #4CAF50;
        }

        .status-inactive {
            background: #ccc;
        }

        .status-text {
            font-size: 0.8em;
            color: #666;
        }

        /* åŠ¨ç”»æ ·å¼ */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .sidebar {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
        }

        .agents-panel {
            margin-bottom: 30px;
        }

        .agents-panel h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .agent-card {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }

        .agent-architect {
            border-left-color: #4CAF50;
        }

        .agent-evaluator {
            border-left-color: #FF9800;
        }

        .agent-implementer {
            border-left-color: #2196F3;
        }

        .agent-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .agent-status {
            font-size: 0.9em;
            color: #666;
        }

        .methodology-panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .methodology-panel h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .insight-item {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 3px solid #28a745;
            font-size: 0.9em;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-active {
            background: #4CAF50;
        }

        .status-inactive {
            background: #ccc;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .typing-indicator {
            display: none;
            padding: 10px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .suggested-topics {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 5px 0;
        }
        
        .topic-button {
            display: inline-flex;
            align-items: center;
            padding: 8px 15px;
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .topic-button:hover {
            background: #bbdefb;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* å·¦è¾¹æ æ ·å¼ - è°ƒæ•´å®½åº¦ï¼Œè®©ä¸­å¤®åŒºåŸŸæ›´å®½æ• */
        .left-sidebar {
            width: 220px; /* å›ºå®šå®½åº¦ï¼Œé‡Šæ”¾æ›´å¤šç©ºé—´ç»™ä¸­å¤®åŒºåŸŸ */
            background: rgba(245, 245, 245, 0.9);
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-size: 1.1em;
            font-weight: 500;
            color: #333;
        }
        
        .block-stats {
            font-size: 0.9em;
            color: #667eea;
            margin: 5px 0;
            font-weight: 500;
        }
        
        .refresh-time {
            font-size: 0.8em;
            color: #666;
            display: block;
            margin-top: 5px;
        }
        
        .sidebar-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            background: white;
        }
        
        .refresh-btn {
            width: 100%;
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* æ–‡æœ¬å—åˆ—è¡¨æ ·å¼ */
        .block-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .text-block {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 3px solid #667eea;
            transition: all 0.3s;
        }
        
        .text-block:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateX(5px);
        }
        
        .block-title {
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
            font-size: 0.95em;
        }
        
        .block-content {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            line-clamp: 3;
        }
        
        .block-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            color: #999;
        }
        
        .block-connections {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #eee;
            font-size: 0.8em;
        }
        
        .connection-tag {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-radius: 10px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 0.75em;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 0.9em;
        }
        
        /* è°ƒæ•´ä¸»å†…å®¹åŒºåŸŸå¸ƒå±€ - å¢å¤§ä¸­å¤®äº¤äº’åŒºæ¯”ä¾‹ */
        .main-content {
            display: flex;
            flex: 1; /* å æ®å‰©ä½™ç©ºé—´ï¼Œç¡®ä¿å¡«æ»¡æ•´ä¸ªå®¹å™¨ */
            min-height: 0; /* è§£å†³flexå­å…ƒç´ çš„æœ€å°é«˜åº¦é—®é¢˜ */
        }
        
        .chat-area {
            flex: 6; /* å¢å¤§åˆ°6ï¼Œå æ®ä¸»è¦ç©ºé—´ */
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
        }
        
        .sidebar {
            flex: 1.2; /* é€‚å½“å¢å¤§å³è¾¹æ ï¼Œä¿æŒåŠŸèƒ½å®Œæ•´æ€§ */
            background: #f8f9fa;
            padding: 15px; /* ä¿æŒç´§å‡‘ */
            overflow: hidden;
        }
        
        /* æ‹–æ‹½æ‰‹æŸ„æ ·å¼ */
        .resize-handle {
            width: 5px;
            background-color: rgba(102, 126, 234, 0.3);
            cursor: col-resize;
            transition: all 0.2s ease;
            user-select: none;
            position: relative;
            z-index: 100;
        }
        
        .resize-handle:hover,
        .resize-handle.active {
            background-color: rgba(102, 126, 234, 0.8);
            width: 8px;
        }
        
        /* ç¡®ä¿å·¦å³è¾¹æ å¯ä»¥è°ƒæ•´å¤§å° */
        .left-sidebar {
            min-width: 180px; /* æœ€å°å®½åº¦ */
            max-width: 400px; /* æœ€å¤§å®½åº¦ */
            flex-shrink: 0;
        }
        
        .chat-area {
            flex: 1;
            min-width: 400px; /* æœ€å°å®½åº¦ */
        }
        
        .sidebar {
            min-width: 150px; /* æœ€å°å®½åº¦ */
            max-width: 350px; /* æœ€å¤§å®½åº¦ */
            flex-shrink: 0;
        }

        /* ç»„åˆè¾“å…¥åŒºåŸŸæ ·å¼ */
        .combined-input-area {
            position: relative;
        }

        /* å¸¦æŒ‰é’®çš„è¾“å…¥åŒºåŸŸ */
        .input-with-buttons {
            position: relative;
            width: 100%;
        }

        /* è¾“å…¥ç»„æ ·å¼ */
        .input-group {
            width: 100%;
        }

        /* æ–‡ä»¶æ‹–æ‹½ä¸Šä¼ æ ·å¼ */
        .drag-drop-area {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px dashed transparent;
            border-radius: 10px;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 10;
        }

        .drag-drop-area.dragover {
            border-color: #667eea;
            background-color: rgba(227, 242, 253, 0.5);
            pointer-events: auto;
        }

        /* ä¸Šä¼ æŒ‰é’®å®¹å™¨ */
        .upload-buttons {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 20;
        }

        /* å‘é€æŒ‰é’®æ ·å¼ */
        .send-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            font-size: 1.2em;
        }

        .send-button:hover {
            transform: scale(1.05);
        }

        /* è¾“å…¥æ¡†æ ·å¼ */
        #messageInput {
            width: 100%;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px 180px 12px 20px;
            font-size: 1em;
            resize: vertical;
            outline: none;
            transition: border-color 0.3s;
            max-height: 300px;
            min-height: 120px;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }

        #messageInput:focus {
            border-color: #667eea;
        }
        
        /* æ€è€ƒæ­¥éª¤æ ·å¼ */
        .thinking-step {
            margin: 8px 0;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            font-size: 0.9em;
            display: flex;
            align-items: flex-start;
        }
        
        .step-number {
            margin-right: 10px;
            font-weight: bold;
            color: #667eea;
            min-width: 20px;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-timestamp {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="chatroom-container">
        <div class="main-content">
            <!-- å·¦è¾¹æ  - æ–‡æœ¬å—å…³è”å±•ç¤º -->
            <div class="left-sidebar" id="leftSidebar">
                <div class="sidebar-header">
                    <h3>ğŸ“Š æ–‡æœ¬å—å…³è”ä¸æ€ç»´ç»“æ„</h3>
                    <div class="block-stats">
                        <span id="totalBlocks">0</span> ä¸ªæ–‡æœ¬å— Â· <span id="thoughtNodes">0</span> ä¸ªæ€ç»´èŠ‚ç‚¹ Â· <span id="totalConnections">0</span> æ¡å…³è”
                    </div>
                    <span class="refresh-time" id="refreshTime"></span>
                </div>
                <div class="sidebar-content">
                    <div class="block-list" id="blockList">
                        <div class="loading">åŠ è½½ä¸­æ–‡æœ¬å—æ•°æ®...</div>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <button class="refresh-btn" onclick="refreshTextBlocks()">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°</button>
                </div>
            </div>
            
            <!-- å·¦è¾¹æ æ‹–æ‹½æ‰‹æŸ„ -->
            <div class="resize-handle resize-left" id="resizeLeft"></div>
            
            <!-- ä¸­å¤®äº¤äº’åŒº -->
            <div class="chat-area" id="chatArea">
                <!-- é¢å¤´æ  - ç°åœ¨åªå±äºä¸­å¤®äº¤äº’åŒº -->
                <div class="header">
                    <h1>ğŸ¤– å¤šæ™ºèƒ½ä½“èŠå¤©å®¤</h1>
                    <p>ä¸æ„æ¶å¸ˆã€æ–¹æ¡ˆè¯„ä¼°å¸ˆã€ä»£ç å®ç°å¸ˆä¸€èµ·è®¨è®ºæ™ºèƒ½ä½“ååŒå·¥ä½œæµ</p>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <div class="message system-message">
                        <div class="message-content">
                            æ¬¢è¿æ¥åˆ°å¤šæ™ºèƒ½ä½“èŠå¤©å®¤ï¼æ‚¨å¯ä»¥ä¸ä¸‰ä¸ªæ™ºèƒ½ä½“è®¨è®ºæ¶æ„è®¾è®¡ã€æ–¹æ¡ˆè¯„ä¼°å’Œä»£ç å®ç°ç­‰è¯é¢˜ã€‚
                        </div>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator">
                    æ™ºèƒ½ä½“æ­£åœ¨æ€è€ƒä¸­...
                </div>
                
                <!-- æ€è€ƒæ­¥éª¤æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="thinking-steps" id="thinkingSteps" style="display: none; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; margin: 10px 20px; border-left: 3px solid #667eea;">
                    <h3 style="margin-bottom: 10px; font-size: 1.1em; font-weight: 400;">ğŸ¤” æ™ºèƒ½ä½“æ€è€ƒæ­¥éª¤</h3>
                    <div id="stepsContent"></div>
                </div>
                
                <div class="input-area">
                    <div class="combined-input-area">
                        <div class="drag-drop-area" id="dragDropArea"></div>
                        
                        <div class="input-group">
                            <div class="input-with-buttons">
                                <textarea id="messageInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–æƒ³æ³•...æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ " autocomplete="off" rows="6" resize="vertical"></textarea>
                                
                                <div class="upload-buttons">
                                    <button class="send-button" onclick="document.getElementById('fileInput').click()" title="é€‰æ‹©æ–‡ä»¶">
                                        ğŸ“„
                                    </button>
                                    <button class="send-button" onclick="document.getElementById('imageInput').click()" title="é€‰æ‹©å›¾ç‰‡">
                                        ğŸ–¼ï¸
                                    </button>
                                    <button class="send-button" onclick="handleTakeScreenshot()" title="æˆªå›¾">
                                        âœ‚ï¸
                                    </button>
                                    <button class="send-button" id="sendButton" onclick="sendMessage()" title="å‘é€æ¶ˆæ¯">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="22" y1="2" x2="11" y2="13"></line>
                                            <polygon points="22,2 15,22 11,13 2,9"></polygon>
                                        </svg>
                                    </button>
                                </div>
                                
                                <input type="file" id="fileInput" class="hidden" accept="*/*" onchange="handleFileUpload(this.files)">
                                <input type="file" id="imageInput" class="hidden" accept="image/*" onchange="handleImageUpload(this.files)">
                            </div>
                        </div>
                    </div>
                    
                    <div class="suggested-topics">
                        <button class="topic-button" onclick="setSuggestedTopic('æ¶æ„è®¾è®¡')">ğŸ’¡ è®¨è®ºç³»ç»Ÿæ¶æ„è®¾è®¡</button>
                        <button class="topic-button" onclick="setSuggestedTopic('æ–¹æ¡ˆè¯„ä¼°')">ğŸ“Š è¯„ä¼°æŠ€æœ¯æ–¹æ¡ˆé£é™©</button>
                        <button class="topic-button" onclick="setSuggestedTopic('ä»£ç å®ç°')">ğŸ’» è®¨è®ºä»£ç å®ç°ç»†èŠ‚</button>
                        <button class="topic-button" onclick="setSuggestedTopic('ååŒå·¥ä½œæµ')">ğŸ”„ ä¼˜åŒ–æ™ºèƒ½ä½“ååŒæµç¨‹</button>
                    </div>
                </div>
            </div>
            
            <!-- å³è¾¹æ æ‹–æ‹½æ‰‹æŸ„ -->
            <div class="resize-handle resize-right" id="resizeRight"></div>
            
            <div class="sidebar" id="rightSidebar">
                <div class="sidebar-header">
                    <h3>æ™ºèƒ½ä½“é¢æ¿</h3>
                    <span class="online-count" id="onlineCount">åŠ è½½ä¸­...</span>
                </div>
                
                <div class="agent-list" id="agentList">
                    <!-- æ™ºèƒ½ä½“å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="sidebar-footer">
                    <button class="btn-secondary" onclick="showAgentSettings()">
                        <i class="icon-settings">âš™ï¸</i> æ™ºèƒ½ä½“è®¾ç½®
                    </button>
                    <button class="btn-secondary" onclick="showAgentSummary()" style="margin-top: 10px;">
                        <i class="icon-summary">ğŸ“Š</i> æ™ºèƒ½ä½“æ€»ç»“
                    </button>
                </div>
                
                <div class="methodology-panel">
                    <h3>ğŸ“ˆ æ–¹æ³•è®ºæ´å¯Ÿ</h3>
                    <div id="methodologyInsights">
                        <div class="insight-item">
                            ç­‰å¾…äº¤äº’æ•°æ®ç”Ÿæˆæ–¹æ³•è®ºæ´å¯Ÿ...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- @æœºåˆ¶å¼¹çª— -->
    <div class="mention-popup" id="mentionPopup">
        <!-- æ™ºèƒ½ä½“åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
    </div>

    <!-- æ™ºèƒ½ä½“é€‰æ‹©å¼¹çª— -->
    <div class="overlay" id="overlay"></div>
    <div class="agent-select-modal" id="agentSelectModal">
        <div class="modal-header">
            <h3>é€‰æ‹©æ™ºèƒ½ä½“</h3>
            <p>è¯·é€‰æ‹©è¦@çš„æ™ºèƒ½ä½“</p>
        </div>
        <div class="agent-grid" id="agentGrid">
            <!-- æ™ºèƒ½ä½“é€‰é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="closeAgentSelectModal()">å–æ¶ˆ</button>
            <button class="modal-btn primary" onclick="confirmAgentSelection()">ç¡®å®š</button>
        </div>
    </div>

    <!-- æ™ºèƒ½ä½“è®¾ç½®å¼¹çª— -->
    <div class="agent-settings-modal" id="agentSettingsModal">
        <div class="settings-header">
            <h3>æ™ºèƒ½ä½“è®¾ç½®</h3>
            <p>ç®¡ç†æ™ºèƒ½ä½“çš„è‡ªå®šä¹‰åç§°å’Œé…ç½®</p>
        </div>
        
        <div class="settings-tabs">
            <div class="settings-tab active" onclick="switchSettingsTab('names')">åç§°è®¾ç½®</div>
            <div class="settings-tab" onclick="switchSettingsTab('behavior')">è¡Œä¸ºè®¾ç½®</div>
        </div>
        
        <div class="settings-content">
            <div id="namesTab" class="settings-tab-content">
                <div class="settings-group">
                    <h4>æ™ºèƒ½ä½“è‡ªå®šä¹‰åç§°</h4>
                    <div id="agentNamesSettings">
                        <!-- æ™ºèƒ½ä½“åç§°è®¾ç½®å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <div id="behaviorTab" class="settings-tab-content" style="display: none;">
                <div class="settings-group">
                    <h4>æ™ºèƒ½ä½“è¡Œä¸ºè®¾ç½®</h4>
                    <p>é…ç½®æ™ºèƒ½ä½“çš„å“åº”è¡Œä¸ºå’Œåä½œæ–¹å¼</p>
                    <!-- è¡Œä¸ºè®¾ç½®å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="closeAgentSettingsModal()">å–æ¶ˆ</button>
            <button class="modal-btn primary" onclick="saveAgentSettings()">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <!-- æ™ºèƒ½ä½“æ€»ç»“å¼¹çª— -->
    <div class="agent-settings-modal" id="agentSummaryModal">
        <div class="settings-header">
            <h3>æ™ºèƒ½ä½“æ€»ç»“æŠ¥å‘Š</h3>
            <p>æŸ¥çœ‹æ™ºèƒ½ä½“åœ¨ç‰¹å®šæ—¶é—´æ®µå†…çš„è¡¨ç°æ€»ç»“</p>
        </div>
        
        <div class="settings-content">
            <div class="settings-group">
                <label class="settings-label">é€‰æ‹©æ™ºèƒ½ä½“ï¼š</label>
                <select id="agentSelect" class="settings-input">
                    <option value="æ¶æ„å¸ˆ">æ¶æ„å¸ˆ</option>
                    <option value="è¯„ä¼°å¸ˆ">è¯„ä¼°å¸ˆ</option>
                    <option value="å®ç°å¸ˆ">å®ç°å¸ˆ</option>
                </select>
            </div>
            
            <div class="settings-group">
                <label class="settings-label">æ—¶é—´èŒƒå›´ï¼š</label>
                <select id="timeRange" class="settings-input">
                    <option value="today">ä»Šå¤©</option>
                    <option value="last_week" selected>æœ€è¿‘ä¸€å‘¨</option>
                    <option value="last_month">æœ€è¿‘ä¸€ä¸ªæœˆ</option>
                </select>
            </div>
            
            <div class="settings-group">
                <button class="modal-btn primary" onclick="generateAgentSummary()" style="width: 100%;">
                    ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
                </button>
            </div>
            
            <div id="summaryContent" class="summary-content" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; min-height: 200px; max-height: 400px; overflow-y: auto;">
                <p style="text-align: center; color: #666;">è¯·é€‰æ‹©æ™ºèƒ½ä½“å’Œæ—¶é—´èŒƒå›´ï¼Œç„¶åç‚¹å‡»"ç”Ÿæˆæ€»ç»“æŠ¥å‘Š"</p>
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="closeAgentSummaryModal()">å…³é—­</button>
            <button class="modal-btn primary" onclick="exportSummary()">å¯¼å‡ºæŠ¥å‘Š</button>
        </div>
    </div>

    <script src="/static/js/screenshot.js"></script>
    <script>
        const API_BASE = '/api/chatroom';
        let methodologyInsights = [];
        let agents = []; // åˆå§‹ä¸ºç©ºæ•°ç»„ï¼Œå°†ä»åç«¯åŠ¨æ€è·å–
        let currentMentionStart = -1;
        let selectedAgent = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // é¦–å…ˆä»åç«¯è·å–æ™ºèƒ½ä½“åˆ—è¡¨
            await loadAgentsFromServer();
            
            loadSavedSettings();
            checkChatroomStatus();
            loadConversationHistory();
            initializeAgentSelection();
            setupEventListeners();
            updateAgentList();
            
            // åˆå§‹åŒ–æ–‡æœ¬å—å·¦è¾¹æ 
            initializeTextBlocksSidebar();
            
            // æ·»åŠ é¡µé¢å…³é—­å‰çš„ä¿å­˜æœºåˆ¶
        window.addEventListener('beforeunload', function() {
            saveConversationToLocalStorage();
        });
        
        // å®šæœŸè‡ªåŠ¨ä¿å­˜ï¼ˆæ¯30ç§’ï¼‰
        setInterval(saveConversationToLocalStorage, 30000);
        
        // åˆå§‹åŒ–æ‹–æ‹½è°ƒæ•´å¤§å°åŠŸèƒ½
        initializeResizeFunctionality();
    });
    
    // æ‹–æ‹½è°ƒæ•´å¤§å°åŠŸèƒ½
    function initializeResizeFunctionality() {
        let isResizingLeft = false;
        let isResizingRight = false;
        let startX = 0;
        let startLeftWidth = 0;
        let startChatWidth = 0;
        let startRightWidth = 0;
        
        const leftSidebar = document.getElementById('leftSidebar');
        const chatArea = document.getElementById('chatArea');
        const rightSidebar = document.getElementById('rightSidebar');
        const resizeLeft = document.getElementById('resizeLeft');
        const resizeRight = document.getElementById('resizeRight');
        
        // å·¦è¾¹æ æ‹–æ‹½å¼€å§‹
        resizeLeft.addEventListener('mousedown', function(e) {
            isResizingLeft = true;
            startX = e.clientX;
            startLeftWidth = leftSidebar.offsetWidth;
            startChatWidth = chatArea.offsetWidth;
            this.classList.add('active');
            document.body.style.cursor = 'col-resize';
            
            // ç¦ç”¨é€‰æ‹©
            document.body.style.userSelect = 'none';
        });
        
        // å³è¾¹æ æ‹–æ‹½å¼€å§‹
        resizeRight.addEventListener('mousedown', function(e) {
            isResizingRight = true;
            startX = e.clientX;
            startChatWidth = chatArea.offsetWidth;
            startRightWidth = rightSidebar.offsetWidth;
            this.classList.add('active');
            document.body.style.cursor = 'col-resize';
            
            // ç¦ç”¨é€‰æ‹©
            document.body.style.userSelect = 'none';
        });
        
        // æ‹–æ‹½è¿‡ç¨‹
        document.addEventListener('mousemove', function(e) {
            if (isResizingLeft || isResizingRight) {
                const deltaX = e.clientX - startX;
                
                if (isResizingLeft) {
                    // è®¡ç®—æ–°çš„å·¦è¾¹æ å®½åº¦
                    const newLeftWidth = Math.max(180, Math.min(400, startLeftWidth + deltaX));
                    const widthDiff = newLeftWidth - startLeftWidth;
                    
                    // æ›´æ–°å·¦è¾¹æ å®½åº¦
                    leftSidebar.style.width = newLeftWidth + 'px';
                    
                    // æ›´æ–°ä¸»å†…å®¹åŒºçš„flexå±æ€§
                    chatArea.style.flex = '1';
                } else if (isResizingRight) {
                    // è®¡ç®—æ–°çš„å³è¾¹æ å®½åº¦
                    const newRightWidth = Math.max(150, Math.min(350, startRightWidth - deltaX));
                    
                    // æ›´æ–°å³è¾¹æ å®½åº¦
                    rightSidebar.style.width = newRightWidth + 'px';
                    
                    // æ›´æ–°ä¸»å†…å®¹åŒºçš„flexå±æ€§
                    chatArea.style.flex = '1';
                }
            }
        });
        
        // æ‹–æ‹½ç»“æŸ
        document.addEventListener('mouseup', function() {
            if (isResizingLeft || isResizingRight) {
                isResizingLeft = false;
                isResizingRight = false;
                resizeLeft.classList.remove('active');
                resizeRight.classList.remove('active');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });
        
        // é¼ æ ‡ç¦»å¼€çª—å£æ—¶ç»“æŸæ‹–æ‹½
        document.addEventListener('mouseleave', function() {
            if (isResizingLeft || isResizingRight) {
                isResizingLeft = false;
                isResizingRight = false;
                resizeLeft.classList.remove('active');
                resizeRight.classList.remove('active');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });
    }
    
    // åˆå§‹åŒ–æ–‡æœ¬å—å·¦è¾¹æ 
    function initializeTextBlocksSidebar() {
        // âœ… ä¿®å¤ï¼šåªè°ƒç”¨ä¸€æ¬¡ï¼Œé¿å…é‡å¤åˆ·æ–°å¯¼è‡´æœåŠ¡å™¨é‡å¤æ„å»ºçŸ¥è¯†å›¾è°±
        refreshTextBlocks();
        
        // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
        setInterval(refreshTextBlocks, 5 * 60 * 1000);
    }
    
    // åˆ·æ–°æ–‡æœ¬å—æ•°æ®
    async function refreshTextBlocks() {
        try {
            // ğŸ”§ é€šè¿‡é™æ€æœåŠ¡å™¨ä»£ç†è®¿é—®æ–‡æœ¬å—æ¥å£ï¼Œéµå®ˆç“®åŸ/å®‰å…¨å‰å“¨æ¶æ„
            const response = await fetch('/api/text-blocks');
            const data = await response.json();
            
            if (data.success) {
                // æ›´æ–°æ–‡æœ¬å—åˆ—è¡¨ï¼Œä¼ é€’æ€»æ•°ç»Ÿè®¡ï¼ˆåŒ…å«æ€ç»´èŠ‚ç‚¹æ•°ï¼‰
                updateTextBlocksList(data.blocks, data.count, data.total_connections, data.thought_nodes_count);
                
                // æ›´æ–°åˆ·æ–°æ—¶é—´
                updateRefreshTime();
            } else {
                console.error('è·å–æ–‡æœ¬å—æ•°æ®å¤±è´¥:', data.error);
                showBlockLoadingError();
            }
        } catch (error) {
            console.error('è·å–æ–‡æœ¬å—æ•°æ®æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯:', error);
            showBlockLoadingError();
        }
    }
    
    // æ›´æ–°æ–‡æœ¬å—åˆ—è¡¨
    function updateTextBlocksList(blocks, totalBlocks, totalConnections, thoughtNodesCount) {
        const blockList = document.getElementById('blockList');
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        console.log('[TextBlocks] æ›´æ–°ç»Ÿè®¡', { totalBlocks, thoughtNodesCount, totalConnections, blocksLength: blocks ? blocks.length : 0 });
        document.getElementById('totalBlocks').textContent = totalBlocks || (blocks ? blocks.length : 0);
        document.getElementById('thoughtNodes').textContent = thoughtNodesCount || 0;
        document.getElementById('totalConnections').textContent = totalConnections || 0;
        
        if (!blocks || blocks.length === 0) {
            blockList.innerHTML = '<div class="loading">æš‚æ— æ–‡æœ¬å—æ•°æ®</div>';
            return;
        }
        
        // ç”Ÿæˆæ–‡æœ¬å—HTML
        const blocksHtml = blocks.map(block => {
            return `
                <div class="text-block">
                    <div class="block-title">${block.title || 'æœªå‘½åæ–‡æœ¬å—'}</div>
                    <div class="block-content">${block.content || ''}</div>
                    <div class="block-meta">
                        <span>ID: ${block.id}</span>
                        <span>${block.timestamp || ''}</span>
                    </div>
                    ${block.connections && block.connections.length > 0 ? `
                        <div class="block-connections">
                            <strong>å…³è”:</strong>
                            ${block.connections
                                .filter(conn => conn && (conn.title || conn.id))
                                .map(conn => `<span class="connection-tag">${conn.title || conn.id}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
        
        blockList.innerHTML = blocksHtml;
    }
    
    // æ›´æ–°åˆ·æ–°æ—¶é—´
    function updateRefreshTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('refreshTime').textContent = `ä¸Šæ¬¡åˆ·æ–°: ${timeString}`;
    }
    
    // æ˜¾ç¤ºåŠ è½½é”™è¯¯
    function showBlockLoadingError() {
        const blockList = document.getElementById('blockList');
        blockList.innerHTML = `
            <div class="loading">
                <p>åŠ è½½æ–‡æœ¬å—æ•°æ®å¤±è´¥</p>
                <p style="font-size: 0.8em; margin-top: 5px;">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç‚¹å‡»åˆ·æ–°æŒ‰é’®é‡è¯•</p>
            </div>
        `;
    }
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        
        // è¾“å…¥æ¡†å›è½¦å‘é€
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // è¾“å…¥æ¡†é”®ç›˜äº‹ä»¶å¤„ç†@æœºåˆ¶
        messageInput.addEventListener('keyup', function(e) {
            handleAtSymbol(this);
            
            // å¤„ç†@å¼¹çª—çš„é”®ç›˜å¯¼èˆª
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                navigateMentionPopup(e.key);
            } else if (e.key === 'Enter' && document.getElementById('mentionPopup').style.display === 'block') {
                selectActiveMention();
            } else if (e.key === 'Escape') {
                hideMentionPopup();
            }
        });
        
        // è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶éšè—@å¼¹çª—
        messageInput.addEventListener('blur', function() {
            setTimeout(() => hideMentionPopup(), 150);
        });
        
        // ç‚¹å‡»é®ç½©å±‚å…³é—­å¼¹çª—
        document.getElementById('overlay').addEventListener('click', closeAgentSelectModal);
        
        // å‘é€æŒ‰é’®ç‚¹å‡»
        sendButton.addEventListener('click', sendMessage);
        
        // è¾“å…¥æ¡†å†…å®¹å˜åŒ–æ—¶å¯ç”¨/ç¦ç”¨å‘é€æŒ‰é’®
        messageInput.addEventListener('input', function() {
            sendButton.disabled = !this.value.trim();
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤º@å¼¹çª—
            if (currentMentionStart >= 0) {
                showMentionPopup(this, currentMentionStart);
            }
        });
    }
    
    // å¯¼èˆª@å¼¹çª—
    function navigateMentionPopup(direction) {
        const popup = document.getElementById('mentionPopup');
        if (popup.style.display !== 'block') return;
        
        const items = popup.querySelectorAll('.mention-item');
        if (items.length === 0) return;
        
        let activeIndex = -1;
        items.forEach((item, index) => {
            if (item.classList.contains('active')) {
                activeIndex = index;
                item.classList.remove('active');
            }
        });
        
        if (direction === 'ArrowDown') {
            activeIndex = (activeIndex + 1) % items.length;
        } else if (direction === 'ArrowUp') {
            activeIndex = (activeIndex - 1 + items.length) % items.length;
        }
        
        items[activeIndex].classList.add('active');
    }
    
    // é€‰æ‹©æ´»è·ƒçš„@é¡¹
    function selectActiveMention() {
        const activeItem = document.querySelector('.mention-item.active');
        if (activeItem) {
            const agentId = activeItem.dataset.agentId;
            selectMention(agentId);
        }
    }
    
    // åˆå§‹åŒ–æ™ºèƒ½ä½“é€‰æ‹©åŠŸèƒ½
    function initializeAgentSelection() {
        const agentGrid = document.getElementById('agentGrid');
        agentGrid.innerHTML = '';
        
        agents.forEach(agent => {
            const agentOption = document.createElement('div');
            agentOption.className = 'agent-option';
            agentOption.dataset.agentId = agent.id;
            agentOption.innerHTML = `
                <div class="agent-icon">${agent.icon}</div>
                <div>
                    <div style="font-weight: bold; margin-bottom: 5px;">${agent.nickname}</div>
                    <div style="font-size: 0.9em; color: #666;">${agent.role}</div>
                </div>
            `;
            agentOption.addEventListener('click', () => selectAgentOption(agent.id));
            agentGrid.appendChild(agentOption);
        });
    }
    
    // é€‰æ‹©æ™ºèƒ½ä½“é€‰é¡¹
    function selectAgentOption(agentId) {
        const options = document.querySelectorAll('.agent-option');
        options.forEach(option => option.classList.remove('selected'));
        
        const selectedOption = document.querySelector(`[data-agent-id="${agentId}"]`);
        selectedOption.classList.add('selected');
        selectedAgent = agents.find(agent => agent.id === agentId);
    }
    
    // æ‰“å¼€æ™ºèƒ½ä½“é€‰æ‹©å¼¹çª—
    function openAgentSelectModal() {
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('agentSelectModal').style.display = 'block';
        selectedAgent = null;
        
        const options = document.querySelectorAll('.agent-option');
        options.forEach(option => option.classList.remove('selected'));
    }
    
    // å…³é—­æ™ºèƒ½ä½“é€‰æ‹©å¼¹çª—
    function closeAgentSelectModal() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('agentSelectModal').style.display = 'none';
    }
    
    // ç¡®è®¤æ™ºèƒ½ä½“é€‰æ‹©
    function confirmAgentSelection() {
        if (!selectedAgent) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ™ºèƒ½ä½“');
            return;
        }
        
        const messageInput = document.getElementById('messageInput');
        const currentText = messageInput.value;
        const mentionText = `@${selectedAgent.nickname}`;
        
        if (currentMentionStart >= 0) {
            // æ›¿æ¢ç”¨æˆ·è¾“å…¥çš„@ç¬¦å·å’Œåé¢çš„å†…å®¹
            messageInput.value = currentText.substring(0, currentMentionStart) + mentionText + ' ';
        } else {
            // åœ¨å½“å‰ä½ç½®æ’å…¥@
            messageInput.value = currentText + mentionText + ' ';
        }
        
        closeAgentSelectModal();
        messageInput.focus();
        currentMentionStart = -1;
    }
    
    // å¤„ç†@ç¬¦å·è¾“å…¥
    function handleAtSymbol(input) {
        const value = input.value;
        const cursorPos = input.selectionStart;
        
        // æ£€æŸ¥æ˜¯å¦è¾“å…¥äº†@ç¬¦å·ï¼Œå¹¶ä¸”ç¡®ä¿å½“å‰ä½ç½®æ˜¯@ç¬¦å·
        if (value[cursorPos - 1] === '@') {
            // ç¡®ä¿åªåœ¨@ç¬¦å·ä½ç½®è®¾ç½®currentMentionStart
            currentMentionStart = cursorPos - 1;
            // æ£€æŸ¥@ç¬¦å·å‰ä¸€ä½æ˜¯å¦ä¹Ÿæ˜¯@ç¬¦å·ï¼ˆé¿å…@@æƒ…å†µï¼‰
            if (cursorPos - 2 < 0 || value[cursorPos - 2] !== '@') {
                openAgentSelectModal();
            }
        }
    }
    
    // æ˜¾ç¤º@å¼¹çª—
    function showMentionPopup(input, startPos) {
        const popup = document.getElementById('mentionPopup');
        const searchText = input.value.substring(startPos + 1).toLowerCase();
        
        // è¿‡æ»¤åŒ¹é…çš„æ™ºèƒ½ä½“
        const matchedAgents = agents.filter(agent => 
            agent.nickname.toLowerCase().includes(searchText) ||
            agent.name.toLowerCase().includes(searchText)
        );
        
        if (matchedAgents.length === 0) {
            popup.style.display = 'none';
            return;
        }
        
        // ç”Ÿæˆæ™ºèƒ½ä½“åˆ—è¡¨
        popup.innerHTML = matchedAgents.map(agent => `
            <div class="mention-item" data-agent-id="${agent.id}" onclick="selectMention('${agent.id}')">
                <div class="mention-info">
                    <div class="mention-avatar" style="background: ${agent.color}">${agent.nickname.charAt(0)}</div>
                    <div>
                        <span class="mention-name">${agent.nickname}</span>
                        <span class="mention-role">${agent.role}</span>
                    </div>
                </div>
            </div>
        `).join('');
        
        // å®šä½å¼¹çª—
        const rect = input.getBoundingClientRect();
        popup.style.display = 'block';
        popup.style.bottom = `${window.innerHeight - rect.top + 10}px`;
        popup.style.left = `${rect.left}px`;
        popup.style.width = `${rect.width}px`;
    }
    
    // é€‰æ‹©@æ™ºèƒ½ä½“
    function selectMention(agentId) {
        const agent = agents.find(a => a.id === agentId);
        if (!agent) return;
        
        const messageInput = document.getElementById('messageInput');
        const currentText = messageInput.value;
        const mentionText = `@${agent.nickname}`;
        
        // ğŸ”§ ä¿®å¤ï¼šæ›¿æ¢åŸæœ‰çš„@ç¬¦å·ï¼Œè€Œä¸æ˜¯ä¿ç•™å®ƒ
        // currentMentionStart æŒ‡å‘@ç¬¦å·çš„ä½ç½®ï¼Œæˆ‘ä»¬éœ€è¦ä»@ç¬¦å·ä½ç½®å¼€å§‹æ›¿æ¢æ•´ä¸ª@xxxéƒ¨åˆ†
        // æ‰¾åˆ°@ç¬¦å·åçš„ç¬¬ä¸€ä¸ªç©ºæ ¼æˆ–å­—ç¬¦ä¸²ç»“å°¾ä½œä¸ºæ›¿æ¢ç»ˆç‚¹
        const afterMention = currentText.substring(currentMentionStart + 1);
        const endPos = afterMention.search(/\s/) === -1 ? currentText.length : currentMentionStart + 1 + afterMention.search(/\s/);
        
        messageInput.value = currentText.substring(0, currentMentionStart) + mentionText + ' ' + currentText.substring(endPos);
        messageInput.focus();
        
        // è®¾ç½®å…‰æ ‡ä½ç½®åˆ°@æ™ºèƒ½ä½“åé¢çš„ç©ºæ ¼ä¹‹å
        const cursorPos = currentMentionStart + mentionText.length + 1;
        messageInput.setSelectionRange(cursorPos, cursorPos);
        
        document.getElementById('mentionPopup').style.display = 'none';
        currentMentionStart = -1;
    }
    
    // éšè—@å¼¹çª—
    function hideMentionPopup() {
        document.getElementById('mentionPopup').style.display = 'none';
        currentMentionStart = -1;
    }
    
    // å¤„ç†æ¶ˆæ¯ä¸­çš„@æ ‡ç­¾
    function processMessageMentions(message) {
        // ç¡®ä¿messageæ˜¯å­—ç¬¦ä¸²ç±»å‹
        let processedMessage = typeof message === 'string' ? message : String(message);
        agents.forEach(agent => {
            const mentionPattern = new RegExp(`@${agent.nickname}`, 'g');
            processedMessage = processedMessage.replace(mentionPattern, 
                `<span class="mention-tag agent-mention" style="background: ${agent.color}">@${agent.nickname}</span>`
            );
        });
        return processedMessage;
    }

        // æ™ºèƒ½ä½“è®¾ç½®ç›¸å…³åŠŸèƒ½
        function showAgentSettings() {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('agentSettingsModal').style.display = 'block';
            initializeAgentSettings();
        }

        function closeAgentSettingsModal() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('agentSettingsModal').style.display = 'none';
        }

        function switchSettingsTab(tabName) {
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.settings-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.settings-tab[onclick*="${tabName}"]`).classList.add('active');
            
            // æ˜¾ç¤ºå¯¹åº”å†…å®¹
            document.querySelectorAll('.settings-tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(tabName + 'Tab').style.display = 'block';
        }

        function initializeAgentSettings() {
            const namesContainer = document.getElementById('agentNamesSettings');
            namesContainer.innerHTML = '';
            
            agents.forEach(agent => {
                const agentSetting = document.createElement('div');
                agentSetting.className = 'settings-group';
                agentSetting.innerHTML = `
                    <label class="settings-label">${agent.name} (${agent.role})</label>
                    <input type="text" class="settings-input" id="nickname_${agent.id}" 
                           value="${agent.nickname}" placeholder="è¾“å…¥è‡ªå®šä¹‰æ˜µç§°">
                    <small style="color: #666;">å½“å‰æ˜µç§°: ${agent.nickname}</small>
                `;
                namesContainer.appendChild(agentSetting);
            });
        }

        function saveAgentSettings() {
            // ä¿å­˜æ˜µç§°è®¾ç½®
            agents.forEach(agent => {
                const nicknameInput = document.getElementById(`nickname_${agent.id}`);
                if (nicknameInput && nicknameInput.value.trim()) {
                    agent.nickname = nicknameInput.value.trim();
                }
            });
            
            // æ›´æ–°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('agentSettings', JSON.stringify(agents));
            
            // æ›´æ–°ç•Œé¢
            updateAgentList();
            initializeAgentSelection();
            
            closeAgentSettingsModal();
            showNotification('æ™ºèƒ½ä½“è®¾ç½®å·²ä¿å­˜');
        }

        function showNotification(message) {
            // ç®€å•çš„é€šçŸ¥å®ç°
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 3000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // æ›´æ–°æ™ºèƒ½ä½“åˆ—è¡¨æ˜¾ç¤º
        function updateAgentList() {
            const agentList = document.getElementById('agentList');
            const onlineCountElement = document.getElementById('onlineCount');
            agentList.innerHTML = '';
            
            if (!agents || agents.length === 0) {
                if (onlineCountElement) {
                    onlineCountElement.textContent = 'æš‚æ— æ™ºèƒ½ä½“åœ¨çº¿';
                }
                return;
            }
            
            agents.forEach(agent => {
                const agentCard = document.createElement('div');
                agentCard.className = 'agent-card';
                agentCard.innerHTML = `
                    <div class="agent-info">
                        <div class="agent-avatar" style="background: ${agent.color}">${agent.icon}</div>
                        <div class="agent-details">
                            <div class="agent-nickname">${agent.nickname}</div>
                            <div class="agent-role">${agent.role}</div>
                        </div>
                    </div>
                    <div class="agent-status">
                        <span class="status-indicator status-active"></span>
                        <span class="status-text">åœ¨çº¿</span>
                    </div>
                `;
                agentList.appendChild(agentCard);
            });

            // åŒæ­¥æ›´æ–°åœ¨çº¿æ•°é‡æ–‡æ¡ˆ
            if (onlineCountElement) {
                onlineCountElement.textContent = `${agents.length} ä¸ªæ™ºèƒ½ä½“åœ¨çº¿`;
            }
        }

        // åŠ è½½ä¿å­˜çš„è®¾ç½®
        function loadSavedSettings() {
            const savedSettings = localStorage.getItem('agentSettings');
            if (savedSettings) {
                try {
                    const savedAgents = JSON.parse(savedSettings);
                    agents.forEach((agent, index) => {
                        if (savedAgents[index] && savedAgents[index].nickname) {
                            agent.nickname = savedAgents[index].nickname;
                        }
                    });
                } catch (e) {
                    console.warn('åŠ è½½æ™ºèƒ½ä½“è®¾ç½®å¤±è´¥:', e);
                }
            }
        }

        // ä»æœåŠ¡å™¨åŠ è½½æ™ºèƒ½ä½“åˆ—è¡¨
        async function loadAgentsFromServer() {
            const onlineCountElement = document.getElementById('onlineCount');
            if (onlineCountElement) {
                onlineCountElement.textContent = 'åŠ è½½ä¸­...';
            }
            try {
                const response = await fetch(`${API_BASE}/agents`);
                const data = await response.json();
                
                if (data.success && data.agents) {
                    // ä¸ºä¸åŒæ™ºèƒ½ä½“IDå’Œç±»åè®¾ç½®æ˜ å°„ï¼Œé€‚é…æ™ºèƒ½ä½“å‘ç°å¼•æ“è¿”å›çš„ç»“æœ
                    const colorMap = {
                        'SystemArchitectAgent': '#4CAF50',
                        'SchemeEvaluatorAgent': '#2196F3', 
                        'CodeImplementerAgent': '#FF9800',
                        'DataCollectorAgent': '#9C27B0',
                        'system_architect': '#4CAF50',
                        'scheme_evaluator': '#2196F3',
                        'code_implementer': '#FF9800',
                        'data_collector': '#9C27B0',
                        'architect': '#4CAF50',
                        'evaluator': '#2196F3',
                        'implementer': '#FF9800',
                        'error_handler': '#FF5722'
                    };
                    
                    // ä¸ºä¸åŒæ™ºèƒ½ä½“IDå’Œç±»åè®¾ç½®å›¾æ ‡æ˜ å°„
                    const iconMap = {
                        'SystemArchitectAgent': 'ğŸ—ï¸',
                        'SchemeEvaluatorAgent': 'ğŸ“Š',
                        'CodeImplementerAgent': 'ğŸ’»',
                        'DataCollectorAgent': 'ğŸ”',
                        'system_architect': 'ğŸ—ï¸',
                        'scheme_evaluator': 'ğŸ“Š',
                        'code_implementer': 'ğŸ’»',
                        'data_collector': 'ğŸ”',
                        'architect': 'ğŸ—ï¸',
                        'evaluator': 'ğŸ“Š',
                        'implementer': 'ğŸ’»',
                        'maintenance': 'ğŸ”§'
                    };
                    
                    // ç±»ååˆ°è§’è‰²åçš„æ˜ å°„
                    const roleMap = {
                        'SystemArchitectAgent': 'æ¶æ„å¸ˆ',
                        'SchemeEvaluatorAgent': 'æ–¹æ¡ˆè¯„ä¼°å¸ˆ',
                        'CodeImplementerAgent': 'ä»£ç å®ç°å¸ˆ',
                        'DataCollectorAgent': 'æ•°æ®æ”¶é›†å¸ˆ',
                        'system_architect': 'æ¶æ„å¸ˆ',
                        'scheme_evaluator': 'æ–¹æ¡ˆè¯„ä¼°å¸ˆ',
                        'code_implementer': 'ä»£ç å®ç°å¸ˆ',
                        'data_collector': 'æ•°æ®æ”¶é›†å¸ˆ',
                        'architect': 'æ¶æ„å¸ˆ',
                        'evaluator': 'æ–¹æ¡ˆè¯„ä¼°å¸ˆ',
                        'implementer': 'ä»£ç å®ç°å¸ˆ',
                        'maintenance': 'ç³»ç»Ÿç»´æŠ¤å¸ˆ'
                    };
                    
                    // å°†APIè¿”å›çš„æ™ºèƒ½ä½“æ•°æ®æ˜ å°„åˆ°å‰ç«¯æœŸæœ›çš„æ ¼å¼
                    agents = data.agents.map(agent => {
                        const agentId = agent.id;
                        let role = roleMap[agentId] || agent.role || 'AIæ™ºèƒ½åŠ©æ‰‹';
                        let nickname = roleMap[agentId] || agent.nickname || 'æ™ºèƒ½ä½“';
                        const color = colorMap[agentId] || '#757575';
                        const icon = iconMap[agentId] || agent.icon || 'ğŸ¤–';
                        
                        return {
                            id: agentId,
                            name: agentId,
                            nickname: nickname,
                            role: role,
                            color: color,
                            icon: icon
                        };
                    });
                    
                    console.log('ä»æœåŠ¡å™¨åŠ è½½æ™ºèƒ½ä½“åˆ—è¡¨æˆåŠŸï¼Œå…±', agents.length, 'ä¸ªæ™ºèƒ½ä½“');
                    
                    if (onlineCountElement) {
                        onlineCountElement.textContent = `${agents.length} ä¸ªæ™ºèƒ½ä½“åœ¨çº¿`;
                    }
                } else {
                    console.warn('ä»æœåŠ¡å™¨åŠ è½½æ™ºèƒ½ä½“åˆ—è¡¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ™ºèƒ½ä½“');
                    agents = getDefaultAgents();
                    if (onlineCountElement) {
                        onlineCountElement.textContent = `${agents.length} ä¸ªæ™ºèƒ½ä½“åœ¨çº¿ï¼ˆé»˜è®¤ï¼‰`;
                    }
                }
            } catch (error) {
                console.error('ä»æœåŠ¡å™¨åŠ è½½æ™ºèƒ½ä½“åˆ—è¡¨å¤±è´¥:', error);
                agents = getDefaultAgents();
                if (onlineCountElement) {
                    onlineCountElement.textContent = `${agents.length} ä¸ªæ™ºèƒ½ä½“åœ¨çº¿ï¼ˆé»˜è®¤ï¼Œç½‘ç»œå¼‚å¸¸ï¼‰`;
                }
            }

            // ä¸è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½åˆ·æ–°é¢æ¿ï¼Œé¿å…ä¸€ç›´åœç•™åœ¨â€œåŠ è½½ä¸­â€¦â€
            updateAgentList();
        }

        // è·å–é»˜è®¤æ™ºèƒ½ä½“åˆ—è¡¨ï¼ˆå›é€€æ–¹æ¡ˆï¼‰
        function getDefaultAgents() {
            return [
                {
                    id: 'system_architect',
                    name: 'ç³»ç»Ÿæ¶æ„å¸ˆ',
                    nickname: 'æ¶æ„å¸ˆ',
                    role: 'RAGç³»ç»Ÿæ¶æ„è®¾è®¡ä¸“å®¶',
                    color: '#4CAF50',
                    icon: 'ğŸ—ï¸'
                },
                {
                    id: 'scheme_evaluator', 
                    name: 'æ–¹æ¡ˆè¯„ä¼°å¸ˆ',
                    nickname: 'è¯„ä¼°å¸ˆ',
                    role: 'æ¶æ„æ–¹æ¡ˆè´¨é‡è¯„ä¼°ä¸“å®¶',
                    color: '#FF9800',
                    icon: 'ğŸ“Š'
                },
                {
                    id: 'code_implementer',
                    name: 'ä»£ç å®ç°å¸ˆ', 
                    nickname: 'å®ç°å¸ˆ',
                    role: 'æ¶æ„æ–¹æ¡ˆä»£ç å®ç°ä¸“å®¶',
                    color: '#2196F3',
                    icon: 'ğŸ’»'
                },
                {
                    id: 'data_collector',
                    name: 'æ•°æ®æ”¶é›†å¸ˆ',
                    nickname: 'æ”¶é›†å¸ˆ', 
                    role: 'æ•°æ®æ”¶é›†ä¸é¢„å¤„ç†ä¸“å®¶',
                    color: '#9C27B0',
                    icon: 'ğŸ“š'
                },
                {
                    id: 'maintenance',
                    name: 'ç³»ç»Ÿç»´æŠ¤å¸ˆ',
                    nickname: 'ç»´æŠ¤å¸ˆ',
                    role: 'ç³»ç»Ÿå¥åº·ç›‘æ§ä¸æ•…éšœä¿®å¤ä¸“å®¶',
                    color: '#607D8B',
                    icon: 'ğŸ”§'
                }
            ];
        }

        // æ£€æŸ¥èŠå¤©å®¤çŠ¶æ€
        async function checkChatroomStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();
                
                if (data.success && data.chatroom_status === 'active') {
                    console.log('èŠå¤©å®¤çŠ¶æ€æ­£å¸¸');
                }
            } catch (error) {
                console.error('æ£€æŸ¥èŠå¤©å®¤çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æœ¬åœ°å­˜å‚¨é”®å
        const STORAGE_KEYS = {
            CONVERSATION_HISTORY: 'rag_chatroom_history',
            LAST_UPDATE_TIME: 'rag_chatroom_last_update'
        };

        // ä¿å­˜å¯¹è¯å†å²åˆ°æœ¬åœ°å­˜å‚¨
        function saveConversationToLocalStorage() {
            try {
                const container = document.getElementById('messagesContainer');
                const messages = container.querySelectorAll('.message');
                const history = [];
                
                messages.forEach(messageDiv => {
                    const sender = messageDiv.querySelector('.sender').textContent;
                    const content = messageDiv.querySelector('.message-content').innerHTML;
                    const timestamp = messageDiv.querySelector('.timestamp').textContent;
                    
                    // ç¡®å®šæ¶ˆæ¯ç±»å‹
                    let messageType = 'user_message';
                    if (sender === 'æ„æ¶å¸ˆ' || sender === 'æ–¹æ¡ˆè¯„ä¼°å¸ˆ' || sender === 'ä»£ç å®ç°å¸ˆ' || sender === 'ç³»ç»Ÿç»´æŠ¤å¸ˆ') {
                        messageType = 'agent_response';
                    } else if (sender === 'ç³»ç»Ÿ') {
                        messageType = 'system_notification';
                    }
                    
                    history.push({
                        sender: sender,
                        content: content,
                        message_type: messageType,
                        timestamp: timestamp
                    });
                });
                
                localStorage.setItem(STORAGE_KEYS.CONVERSATION_HISTORY, JSON.stringify(history));
                localStorage.setItem(STORAGE_KEYS.LAST_UPDATE_TIME, Date.now().toString());
                
                console.log('å¯¹è¯å†å²å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œå…±', history.length, 'æ¡æ¶ˆæ¯');
            } catch (error) {
                console.error('ä¿å­˜å¯¹è¯å†å²åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¯¹è¯å†å²
        function loadConversationFromLocalStorage() {
            try {
                const storedHistory = localStorage.getItem(STORAGE_KEYS.CONVERSATION_HISTORY);
                if (storedHistory) {
                    const history = JSON.parse(storedHistory);
                    console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¯¹è¯å†å²ï¼Œå…±', history.length, 'æ¡æ¶ˆæ¯');
                    
                    // æ¸…ç©ºå½“å‰æ˜¾ç¤ºçš„æ¶ˆæ¯
                    const container = document.getElementById('messagesContainer');
                    container.innerHTML = '';
                    
                    // é‡æ–°æ·»åŠ æ‰€æœ‰æ¶ˆæ¯
                    history.forEach(message => {
                        addMessageToChat(message);
                    });
                    
                    scrollToBottom();
                    return true;
                }
            } catch (error) {
                console.error('ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¯¹è¯å†å²å¤±è´¥:', error);
            }
            return false;
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦ä»æœåŠ¡å™¨é‡æ–°åŠ è½½å†å²
        function shouldReloadFromServer() {
            try {
                const lastUpdate = localStorage.getItem(STORAGE_KEYS.LAST_UPDATE_TIME);
                if (!lastUpdate) return true;
                
                // å¦‚æœè¶…è¿‡1å°æ—¶ï¼Œé‡æ–°ä»æœåŠ¡å™¨åŠ è½½
                const oneHour = 60 * 60 * 1000;
                return (Date.now() - parseInt(lastUpdate)) > oneHour;
            } catch (error) {
                return true;
            }
        }

        // åŠ è½½å¯¹è¯å†å²
        async function loadConversationHistory() {
            // é¦–å…ˆå°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½
            const loadedFromLocal = loadConversationFromLocalStorage();
            
            // å¦‚æœæœ¬åœ°æ²¡æœ‰æ•°æ®æˆ–éœ€è¦é‡æ–°åŠ è½½ï¼Œåˆ™ä»æœåŠ¡å™¨è·å–
            if (!loadedFromLocal || shouldReloadFromServer()) {
                try {
                    const response = await fetch(`${API_BASE}/history`);
                    const data = await response.json();
                    
                    if (data.success) {
                        // æ¸…ç©ºå½“å‰æ˜¾ç¤ºçš„æ¶ˆæ¯
                        const container = document.getElementById('messagesContainer');
                        container.innerHTML = '';
                        
                        // æ·»åŠ æœåŠ¡å™¨è¿”å›çš„æ¶ˆæ¯
                        data.history.forEach(message => {
                            addMessageToChat(message);
                        });
                        
                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                        saveConversationToLocalStorage();
                        scrollToBottom();
                        
                        console.log('ä»æœåŠ¡å™¨åŠ è½½å¯¹è¯å†å²æˆåŠŸï¼Œå…±', data.history.length, 'æ¡æ¶ˆæ¯');
                    }
                } catch (error) {
                    console.error('ä»æœåŠ¡å™¨åŠ è½½å¯¹è¯å†å²å¤±è´¥:', error);
                }
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // ç¦ç”¨å‘é€æŒ‰é’®
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addUserMessage(message);
            input.value = '';
            
            // æ˜¾ç¤ºè¾“å…¥ä¸­æŒ‡ç¤ºå™¨
            showTypingIndicator();
            
            // æ˜¾ç¤ºæ€è€ƒæ­¥éª¤åŒºåŸŸ
            showThinkingSteps();
            
            try {
                const response = await fetch(`${API_BASE}/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message
                    })
                });
                
                const data = await response.json();
                
                // æ¸²æŸ“çœŸå®çš„æ€ç»´æ­¥éª¤ï¼ˆæ¥è‡ªåç«¯ï¼‰
                if (data.thinking_steps && data.thinking_steps.length > 0) {
                    data.thinking_steps.forEach((step, index) => {
                        const stepPrefix = step.agent_name ? `${step.agent_name}ï¼š` : '';
                        addThinkingStep(index + 1, `${stepPrefix}${step.content}`);
                    });
                }
                
                if (data.success) {
                    // éšè—è¾“å…¥ä¸­æŒ‡ç¤ºå™¨
                    hideTypingIndicator();
                    
                    // æ˜¾ç¤ºæ™ºèƒ½ä½“å“åº”
                    data.agent_responses.forEach(agentResponse => {
                        addAgentMessage(agentResponse);
                    });
                    
                    // æ›´æ–°æ–¹æ³•è®ºæ´å¯Ÿ
                    if (data.methodology_insights && data.methodology_insights.length > 0) {
                        updateMethodologyInsights(data.methodology_insights);
                    }
                    
                    // ä¿å­˜å¯¹è¯å†å²åˆ°æœ¬åœ°å­˜å‚¨
                    saveConversationToLocalStorage();
                    scrollToBottom();
                } else {
                    throw new Error(data.error || 'å‘é€æ¶ˆæ¯å¤±è´¥');
                }
                
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                hideTypingIndicator();
                addSystemMessage('å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                // éšè—æ€è€ƒæ­¥éª¤åŒºåŸŸ
                hideThinkingSteps();
                
                // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                sendButton.disabled = false;
                input.focus();
            }
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        function addUserMessage(content) {
            const message = {
                sender: 'ç”¨æˆ·',
                content: content,
                message_type: 'user_message',
                timestamp: new Date().toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                })
            };
            addMessageToChat(message);
        }

        // æ·»åŠ æ™ºèƒ½ä½“æ¶ˆæ¯
        function addAgentMessage(agentResponse) {
            addMessageToChat(agentResponse);
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(content) {
            const message = {
                sender: 'ç³»ç»Ÿ',
                content: content,
                message_type: 'system_notification',
                timestamp: new Date().toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                })
            };
            addMessageToChat(message);
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessageToChat(message) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®æ ·å¼
            let messageClass = 'message ';
            
            switch (message.message_type) {
                case 'user_message':
                    messageClass += 'user-message';
                    break;
                case 'agent_response':
                    messageClass += 'agent-message ';
                    if (message.sender === 'æ„æ¶å¸ˆ') messageClass += 'architect-message';
                    else if (message.sender === 'æ–¹æ¡ˆè¯„ä¼°å¸ˆ') messageClass += 'evaluator-message';
                    else if (message.sender === 'ä»£ç å®ç°å¸ˆ') messageClass += 'implementer-message';
                    break;
                case 'system_notification':
                    messageClass += 'system-message';
                    break;
                case 'methodology_insight':
                    messageClass += 'methodology-insight';
                    break;
            }
            
            messageDiv.className = messageClass;
            
            // å¤„ç†æ¶ˆæ¯ä¸­çš„@æ ‡ç­¾
            const processedContent = processMessageMentions(message.content);
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="sender">${message.sender}</span>
                    <span class="timestamp">${message.timestamp}</span>
                </div>
                <div class="message-content">${processedContent}</div>
            `;
            
            container.appendChild(messageDiv);
            scrollToBottom();
        }

        // æ˜¾ç¤ºè¾“å…¥ä¸­æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            scrollToBottom();
        }

        // éšè—è¾“å…¥ä¸­æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        // æ›´æ–°æ–¹æ³•è®ºæ´å¯Ÿ
        function updateMethodologyInsights(newInsights) {
            methodologyInsights = [...methodologyInsights, ...newInsights].slice(-5); // ä¿ç•™æœ€è¿‘5æ¡
            
            const insightsContainer = document.getElementById('methodologyInsights');
            insightsContainer.innerHTML = '';
            
            methodologyInsights.forEach(insight => {
                const insightDiv = document.createElement('div');
                insightDiv.className = 'insight-item';
                insightDiv.textContent = insight;
                insightsContainer.appendChild(insightDiv);
            });
        }

        // è®¾ç½®å»ºè®®è¯é¢˜
        function setSuggestedTopic(topic) {
            const input = document.getElementById('messageInput');
            input.value = topic;
            input.focus();
        }

        // å¯¼å‡ºæ–¹æ³•è®ºæ´å¯Ÿ
        function exportMethodologyInsights() {
            if (methodologyInsights.length === 0) {
                alert('æš‚æ— æ–¹æ³•è®ºæ´å¯Ÿå¯å¯¼å‡º');
                return;
            }
            
            const content = methodologyInsights.join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'æ–¹æ³•è®ºæ´å¯Ÿ.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ–‡ä»¶æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
        function setupDragDrop() {
            const dragDropArea = document.getElementById('dragDropArea');
            const messageInput = document.getElementById('messageInput');
            
            // å…¨å±€é˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„æ‹–æ‹½è¡Œä¸ºï¼ˆé˜²æ­¢æ‰“å¼€æ–‡ä»¶ï¼‰
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.body.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });
            
            // æ‹–æ‹½äº‹ä»¶å¤„ç† - dragDropArea
            ['dragenter', 'dragover'].forEach(eventName => {
                dragDropArea.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    dragDropArea.classList.add('dragover');
                }, false);
                
                messageInput.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    dragDropArea.classList.add('dragover');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dragDropArea.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    dragDropArea.classList.remove('dragover');
                }, false);
                
                messageInput.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    dragDropArea.classList.remove('dragover');
                }, false);
            });
            
            // å¤„ç†æ–‡ä»¶æ‹–æ‹½ - dropäº‹ä»¶
            dragDropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dragDropArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files && files.length > 0) {
                    handleFileUpload(files);
                }
            }, false);
            
            messageInput.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dragDropArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files && files.length > 0) {
                    handleFileUpload(files);
                }
            }, false);
            
            console.log('æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½å·²å¯ç”¨ï¼Œå·²é˜»æ­¢æµè§ˆå™¨é»˜è®¤æ‹–æ‹½è¡Œä¸º');
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(files) {
            if (files.length === 0) return;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                console.log('ä¸Šä¼ æ–‡ä»¶:', file.name, file.type, file.size);
                
                // è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡ä»¶ä¸Šä¼ çš„é€»è¾‘
                // ä¾‹å¦‚ï¼šå°†æ–‡ä»¶è½¬æ¢ä¸ºBase64ï¼Œç„¶åå‘é€åˆ°æœåŠ¡å™¨
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = e.target.result;
                    // è¿™é‡Œå¯ä»¥å°†æ–‡ä»¶æ•°æ®æ·»åŠ åˆ°æ¶ˆæ¯ä¸­ï¼Œæˆ–è€…å•ç‹¬å‘é€åˆ°æœåŠ¡å™¨
                    console.log('æ–‡ä»¶è¯»å–å®Œæˆ:', file.name, fileData.substring(0, 100) + '...');
                    
                    // æ˜¾ç¤ºä¸Šä¼ æˆåŠŸæç¤º
                    showNotification(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${file.name}`);
                };
                reader.readAsDataURL(file);
            }
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(files) {
            if (files.length === 0) return;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                console.log('ä¸Šä¼ å›¾ç‰‡:', file.name, file.type, file.size);
                
                // è¿™é‡Œå¯ä»¥æ·»åŠ å›¾ç‰‡ä¸Šä¼ çš„é€»è¾‘
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    // è¿™é‡Œå¯ä»¥å°†å›¾ç‰‡æ•°æ®æ·»åŠ åˆ°æ¶ˆæ¯ä¸­ï¼Œæˆ–è€…å•ç‹¬å‘é€åˆ°æœåŠ¡å™¨
                    console.log('å›¾ç‰‡è¯»å–å®Œæˆ:', file.name, imageData.substring(0, 100) + '...');
                    
                    // æ˜¾ç¤ºä¸Šä¼ æˆåŠŸæç¤º
                    showNotification(`å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: ${file.name}`);
                };
                reader.readAsDataURL(file);
            }
        }

        // æˆªå›¾åŠŸèƒ½ - è°ƒç”¨å¤–éƒ¨æ–‡ä»¶ä¸­çš„å®ç°
        function handleTakeScreenshot() {
            // è°ƒç”¨å¤–éƒ¨screenshot.jsæ–‡ä»¶ä¸­çš„takeScreenshotå‡½æ•°
            takeScreenshot(addUserMessage);
        }

        // åˆå§‹åŒ–æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            setupDragDrop();
        });
        
        // æ˜¾ç¤ºæ€è€ƒæ­¥éª¤
        function showThinkingSteps() {
            const thinkingSteps = document.getElementById('thinkingSteps');
            thinkingSteps.style.display = 'block';
        }
        
        // æ·»åŠ æ€è€ƒæ­¥éª¤
        function addThinkingStep(stepNumber, content) {
            const stepsContent = document.getElementById('stepsContent');
            const stepDiv = document.createElement('div');
            stepDiv.className = 'thinking-step';
            
            const now = new Date();
            const timestamp = now.toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            stepDiv.innerHTML = `
                <div class="step-number">${stepNumber}.</div>
                <div class="step-content">
                    <div>${content}</div>
                    <div class="step-timestamp">${timestamp}</div>
                </div>
            `;
            
            stepsContent.appendChild(stepDiv);
            
            // æ»šåŠ¨åˆ°æœ€æ–°æ­¥éª¤
            const thinkingSteps = document.getElementById('thinkingSteps');
            thinkingSteps.scrollTop = thinkingSteps.scrollHeight;
        }
        
        // éšè—æ€è€ƒæ­¥éª¤
        function hideThinkingSteps() {
            const thinkingSteps = document.getElementById('thinkingSteps');
            thinkingSteps.style.display = 'none';
            // æ¸…ç©ºæ­¥éª¤å†…å®¹
            document.getElementById('stepsContent').innerHTML = '';
        }

        // æ˜¾ç¤ºæ™ºèƒ½ä½“æ€»ç»“å¼¹çª—
        function showAgentSummary() {
            document.getElementById('agentSummaryModal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        // å…³é—­æ™ºèƒ½ä½“æ€»ç»“å¼¹çª—
        function closeAgentSummaryModal() {
            document.getElementById('agentSummaryModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        // ç”Ÿæˆæ™ºèƒ½ä½“æ€»ç»“æŠ¥å‘Š
        async function generateAgentSummary() {
            const agentSelect = document.getElementById('agentSelect');
            const timeRange = document.getElementById('timeRange');
            const summaryContent = document.getElementById('summaryContent');
            
            const agentRole = agentSelect.value;
            const timeRangeValue = timeRange.value;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            summaryContent.innerHTML = '<p style="text-align: center; color: #666;">æ­£åœ¨ç”Ÿæˆæ€»ç»“æŠ¥å‘Šï¼Œè¯·ç¨å€™...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/summary`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        agent_role: agentRole,
                        time_range: timeRangeValue
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const summary = data.summary;
                    
                    // æ ¼å¼åŒ–æ˜¾ç¤ºæ€»ç»“æŠ¥å‘Š
                    let html = `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #333; margin-bottom: 10px;">${summary.agent_role}æ™ºèƒ½ä½“æ€»ç»“æŠ¥å‘Š</h4>
                            <p style="color: #666; font-size: 0.9em;">æ—¶é—´èŒƒå›´: ${summary.time_range}</p>
                            <p style="color: #666; font-size: 0.9em;">æ€»äº¤äº’è®°å½•: ${summary.total_memories}æ¡</p>
                            <p style="color: #666; font-size: 0.9em;">é‡è¦å‘è¨€: ${summary.success_count}æ¡</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                            <h5 style="color: #333; margin-bottom: 10px;">æ€»ç»“å†…å®¹:</h5>
                            <div style="white-space: pre-wrap; line-height: 1.6;">${summary.summary}</div>
                        </div>
                    `;
                    
                    // æ·»åŠ å…³é”®æ´å¯Ÿ
                    if (summary.key_insights && summary.key_insights.length > 0) {
                        html += `
                            <div style="margin-top: 20px;">
                                <h5 style="color: #333; margin-bottom: 10px;">å…³é”®æ´å¯Ÿ:</h5>
                                <ul style="background: white; padding: 15px; border-radius: 8px;">
                                    ${summary.key_insights.map(insight => `<li style="margin-bottom: 5px;">${insight}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    summaryContent.innerHTML = html;
                } else {
                    summaryContent.innerHTML = `<p style="color: #d32f2f; text-align: center;">ç”Ÿæˆæ€»ç»“å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</p>`;
                }
                
            } catch (error) {
                console.error('ç”Ÿæˆæ™ºèƒ½ä½“æ€»ç»“å¤±è´¥:', error);
                summaryContent.innerHTML = '<p style="color: #d32f2f; text-align: center;">ç”Ÿæˆæ€»ç»“å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>';
            }
        }

        // å¯¼å‡ºæ€»ç»“æŠ¥å‘Š
        function exportSummary() {
            const summaryContent = document.getElementById('summaryContent');
            const textContent = summaryContent.innerText || summaryContent.textContent;
            
            if (!textContent || textContent.includes('è¯·é€‰æ‹©æ™ºèƒ½ä½“')) {
                alert('è¯·å…ˆç”Ÿæˆæ€»ç»“æŠ¥å‘Š');
                return;
            }
            
            const agentSelect = document.getElementById('agentSelect');
            const timeRange = document.getElementById('timeRange');
            const filename = `${agentSelect.value}_${timeRange.value}_æ€»ç»“æŠ¥å‘Š.txt`;
            
            const blob = new Blob([textContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>